<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E15T075SB3"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-E15T075SB3');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/book-aspnet-htmx">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.822742488781">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Deploying htmx Applications on Azure</title>
    <meta name="title" content="Deploying htmx Applications on Azure">
    <meta name="description" content="Building an htmx application is only half the work.">

    <!-- Canonical -->
    <link rel="canonical" href="https://cwoodruff.github.io/book-aspnet-htmx/chapter23/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cwoodruff.github.io/book-aspnet-htmx/chapter23/">
    <meta property="og:title" content="Deploying htmx Applications on Azure">
    <meta property="og:description" content="Building an htmx application is only half the work.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://cwoodruff.github.io/book-aspnet-htmx/chapter23/">
    <meta property="twitter:title" content="Deploying htmx Applications on Azure">
    <meta property="twitter:description" content="Building an htmx application is only half the work.">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../images/favicon.png" rel="icon">
    <link href="../resources/css/retype.css?v=3.11.0.822742488781" rel="stylesheet">

    <script data-cfasync="false" src="../resources/js/config.js?v=3.11.0.822742488781" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../resources/js/lunr.js?v=3.11.0.822742488781" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../resources/js/prism.js?v=3.11.0.822742488781" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../" class="flex items-center leading-snug text-xl">
                            <span class="w-10 mr-2 grow-0 shrink-0 overflow-hidden">
                                <img class="max-h-10 dark:hidden md:inline-block" src="../images/network200.png">
                                <img class="max-h-10 hidden dark:inline-block" src="../images/network200.png">
                            </span>
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">ASP.NET Core Reimagined with htmx</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">v1</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="../">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M11.03 2.59a1.501 1.501 0 0 1 1.94 0l7.5 6.363a1.5 1.5 0 0 1 .53 1.144V19.5a1.5 1.5 0 0 1-1.5 1.5h-5.75a.75.75 0 0 1-.75-.75V14h-2v6.25a.75.75 0 0 1-.75.75H4.5A1.5 1.5 0 0 1 3 19.5v-9.403c0-.44.194-.859.53-1.144ZM12 3.734l-7.5 6.363V19.5h5v-6.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v6.25h5v-9.403Z"/>
                                        </g>
                                    </svg>
                                    <span>Home</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/cwoodruff/book-aspnet-htmx/issues" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 14.25 14H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 15.543V14H1.75A1.75 1.75 0 0 1 0 12.25v-9.5C0 1.784.784 1 1.75 1ZM1.5 2.75v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"/><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5Z"/>
                                        </g>
                                    </svg>
                                    <span>Issues</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://bsky.app/profile/woodruff.dev" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M18.231,3.618c-2.312,1.736-4.785,5.107-5.948,7.244c-0.123,0.226-0.444,0.226-0.567,0	c-1.163-2.137-3.636-5.508-5.948-7.244C3.949,2.252,1,1.195,1,4.559c0,0.672,0.385,5.643,0.611,6.451	c0.606,2.169,2.454,3.089,4.437,3.195c0.19,0.01,0.222,0.261,0.043,0.324c-2.988,1.048-3.518,3.196-1.424,5.344	c3.826,3.894,5.814,0.647,6.733-1.514c0.224-0.525,0.977-0.525,1.2,0c0.92,2.161,2.907,5.408,6.733,1.514	c2.093-2.148,1.564-4.296-1.424-5.344c-0.179-0.063-0.146-0.313,0.043-0.324c1.983-0.106,3.83-1.026,4.437-3.195	C22.615,10.203,23,5.231,23,4.559C23,1.195,20.051,2.252,18.231,3.618z"></path>
                                        </g>
                                    </svg>
                                    <span>Bluesky</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://mastodon.social/@cwoodruff" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a4 4 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522q0-1.288.66-2.046c.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764q.662.757.661 2.046z"/>
                                        </g>
                                    </svg>
                                    <span>Mastodon</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="../">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M11.03 2.59a1.501 1.501 0 0 1 1.94 0l7.5 6.363a1.5 1.5 0 0 1 .53 1.144V19.5a1.5 1.5 0 0 1-1.5 1.5h-5.75a.75.75 0 0 1-.75-.75V14h-2v6.25a.75.75 0 0 1-.75.75H4.5A1.5 1.5 0 0 1 3 19.5v-9.403c0-.44.194-.859.53-1.144ZM12 3.734l-7.5 6.363V19.5h5v-6.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v6.25h5v-9.403Z"/>
                                                </g>
                                            </svg>
                                            <span>Home</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/cwoodruff/book-aspnet-htmx/issues" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 14.25 14H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 15.543V14H1.75A1.75 1.75 0 0 1 0 12.25v-9.5C0 1.784.784 1 1.75 1ZM1.5 2.75v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"/><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5Z"/>
                                                </g>
                                            </svg>
                                            <span>Issues</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://bsky.app/profile/woodruff.dev" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M18.231,3.618c-2.312,1.736-4.785,5.107-5.948,7.244c-0.123,0.226-0.444,0.226-0.567,0	c-1.163-2.137-3.636-5.508-5.948-7.244C3.949,2.252,1,1.195,1,4.559c0,0.672,0.385,5.643,0.611,6.451	c0.606,2.169,2.454,3.089,4.437,3.195c0.19,0.01,0.222,0.261,0.043,0.324c-2.988,1.048-3.518,3.196-1.424,5.344	c3.826,3.894,5.814,0.647,6.733-1.514c0.224-0.525,0.977-0.525,1.2,0c0.92,2.161,2.907,5.408,6.733,1.514	c2.093-2.148,1.564-4.296-1.424-5.344c-0.179-0.063-0.146-0.313,0.043-0.324c1.983-0.106,3.83-1.026,4.437-3.195	C22.615,10.203,23,5.231,23,4.559C23,1.195,20.051,2.252,18.231,3.618z"></path>
                                                </g>
                                            </svg>
                                            <span>Bluesky</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://mastodon.social/@cwoodruff" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a4 4 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522q0-1.288.66-2.046c.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764q.662.757.661 2.046z"/>
                                                </g>
                                            </svg>
                                            <span>Mastodon</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="deploying-htmx-applications-on-azure" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#deploying-htmx-applications-on-azure">#</doc-anchor-trigger>
        <span>Deploying htmx Applications on Azure</span>
    </h1>
</doc-anchor-target>
<p>Building an htmx application is only half the work. Getting it running reliably in production requires careful configuration, proper infrastructure, and automated deployment pipelines. This chapter takes the Chinook Dashboard from development to a production-ready Azure deployment.</p>
<doc-anchor-target id="231-introduction">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#231-introduction">#</doc-anchor-trigger>
        <span>23.1 Introduction</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="why-deployment-matters-for-htmx-applications">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#why-deployment-matters-for-htmx-applications">#</doc-anchor-trigger>
        <span>Why Deployment Matters for htmx Applications</span>
    </h3>
</doc-anchor-target>
<p>htmx applications have specific characteristics that affect deployment strategy. Understanding these helps you make better infrastructure decisions.</p>
<p><strong>Latency Sensitivity</strong>: htmx makes frequent small requests. Each button click, form submission, or search keystroke triggers a server round-trip. High latency makes applications feel sluggish. Server proximity to users matters more than with traditional page-based applications.</p>
<p><strong>Partial Response Compression</strong>: htmx responses are often small HTML fragments. A table row might be 500 bytes, a form 2KB. Compression algorithms work best on larger payloads, but even small gains add up when users generate dozens of requests per session.</p>
<p><strong>Caching Opportunities</strong>: Some htmx responses are highly cacheable. A genre dropdown or static list doesn&#x27;t change often. Proper cache headers reduce server load and improve response times.</p>
<p><strong>Static Asset Optimization</strong>: htmx.js, Hyperscript, and your CSS are requested on every page load. CDN delivery and aggressive caching for these files significantly improves initial page load.</p>
<doc-anchor-target id="azure-hosting-options">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-hosting-options">#</doc-anchor-trigger>
        <span>Azure Hosting Options</span>
    </h3>
</doc-anchor-target>
<p>Azure offers several ways to host ASP.NET Core applications:</p>
<p><strong>Azure App Service</strong> is the focus of this chapter. It provides managed hosting with automatic OS patching, built-in load balancing, deployment slots, and easy scaling. Best for most web applications.</p>
<p><strong>Azure Container Apps</strong> runs containerized applications with automatic scaling, including scale-to-zero. Good if you want container portability without managing Kubernetes.</p>
<p><strong>Azure Kubernetes Service (AKS)</strong> provides full Kubernetes orchestration. Best for complex microservices architectures or teams already invested in Kubernetes.</p>
<p><strong>Azure Static Web Apps</strong> hosts static files with optional API backends. Not ideal for htmx applications since server-side rendering is central to the pattern.</p>
<p>For the Chinook Dashboard, App Service provides the right balance of simplicity, features, and cost. The patterns in this chapter apply to other hosting options with minor modifications.</p>
<doc-anchor-target id="what-this-chapter-covers">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#what-this-chapter-covers">#</doc-anchor-trigger>
        <span>What This Chapter Covers</span>
    </h3>
</doc-anchor-target>
<p>This chapter walks through:</p>
<ul>
<li>Preparing the application for production (configuration, compression, assets)</li>
<li>Creating Azure resources (App Service, SQL Database, Key Vault)</li>
<li>Building CI/CD pipelines with GitHub Actions</li>
<li>htmx-specific deployment considerations (caching partials, error handling)</li>
<li>Monitoring with Application Insights</li>
<li>Scaling and performance optimization</li>
<li>Security hardening</li>
</ul>
<p>By the end, you&#x27;ll have a fully automated pipeline that builds, tests, and deploys your htmx application to Azure.</p>
<hr>
<doc-anchor-target id="232-preparing-your-application-for-production">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#232-preparing-your-application-for-production">#</doc-anchor-trigger>
        <span>23.2 Preparing Your Application for Production</span>
    </h2>
</doc-anchor-target>
<p>Before deploying, configure your application for production workloads. Development defaults prioritize convenience; production requires security, performance, and reliability.</p>
<doc-anchor-target id="2321-environment-specific-configuration">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2321-environment-specific-configuration">#</doc-anchor-trigger>
        <span>23.2.1 Environment-Specific Configuration</span>
    </h3>
</doc-anchor-target>
<p>ASP.NET Core loads configuration from multiple sources in a specific order. Later sources override earlier ones:</p>
<ol>
<li><code v-pre>appsettings.json</code> (base configuration)</li>
<li><code v-pre>appsettings.{Environment}.json</code> (environment-specific)</li>
<li>Environment variables</li>
<li>Command-line arguments</li>
</ol>
<p>The <code v-pre>ASPNETCORE_ENVIRONMENT</code> variable determines which environment file loads. Azure App Service sets this to &quot;Production&quot; by default.</p>
<p><strong>appsettings.Production.json</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft.AspNetCore&quot;: &quot;Warning&quot;,
      &quot;Microsoft.EntityFrameworkCore&quot;: &quot;Warning&quot;,
      &quot;Microsoft.EntityFrameworkCore.Database.Command&quot;: &quot;Warning&quot;,
      &quot;ChinookDashboard&quot;: &quot;Information&quot;
    }
  },
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConnectionStrings&quot;: {
    &quot;ChinookConnection&quot;: &quot;SET_IN_AZURE_APP_SETTINGS&quot;
  },
  &quot;ApplicationInsights&quot;: {
    &quot;ConnectionString&quot;: &quot;SET_IN_AZURE_APP_SETTINGS&quot;
  },
  &quot;Htmx&quot;: {
    &quot;Timeout&quot;: 30000,
    &quot;HistoryCacheSize&quot;: 10,
    &quot;DefaultSwapStyle&quot;: &quot;innerHTML&quot;,
    &quot;DefaultSettleDelay&quot;: 20,
    &quot;IncludeIndicatorStyles&quot;: true
  },
  &quot;Caching&quot;: {
    &quot;StaticFilesCacheMaxAge&quot;: 23536000,
    &quot;PartialResponsesCacheMaxAge&quot;: 0,
    &quot;EnableResponseCaching&quot;: true
  },
  &quot;Security&quot;: {
    &quot;EnableHsts&quot;: true,
    &quot;HstsMaxAgeDays&quot;: 365,
    &quot;EnableHttpsRedirection&quot;: true
  },
  &quot;FeatureFlags&quot;: {
    &quot;EnableDetailedErrors&quot;: false,
    &quot;EnableSwagger&quot;: false,
    &quot;EnableDeveloperExceptionPage&quot;: false
  }
}</code></pre>
</doc-codeblock></div>
<p><strong>Key points about this configuration:</strong></p>
<ul>
<li><strong>Logging levels</strong>: Set Microsoft namespaces to Warning to reduce noise. Keep your application namespace at Information for useful operational logs.</li>
<li><strong>Connection strings</strong>: Use placeholder values. Actual secrets come from Azure App Settings or Key Vault.</li>
<li><strong>htmx settings</strong>: These values can be injected into your layout for client-side configuration.</li>
<li><strong>Feature flags</strong>: Disable development features in production.</li>
</ul>
<p><strong>Managing Secrets</strong></p>
<p>Never commit secrets to source control. The <code v-pre>appsettings.Production.json</code> contains structure but not actual secrets. Sensitive values come from:</p>
<ol>
<li><strong>Azure App Settings</strong>: Set in the Azure Portal or via CLI</li>
<li><strong>Azure Key Vault</strong>: For highly sensitive secrets with audit logging</li>
<li><strong>Environment variables</strong>: Set by the deployment platform</li>
</ol>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Don't do this - secrets in code
&quot;ConnectionStrings&quot;: {
  &quot;ChinookConnection&quot;: &quot;Server=myserver.database.windows.net;Password=secret123&quot;
}

# Do this - placeholder that Azure overrides
&quot;ConnectionStrings&quot;: {
  &quot;ChinookConnection&quot;: &quot;SET_IN_AZURE_APP_SETTINGS&quot;
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2322-optimizing-static-assets">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2322-optimizing-static-assets">#</doc-anchor-trigger>
        <span>23.2.2 Optimizing Static Assets</span>
    </h3>
</doc-anchor-target>
<p>Production applications should serve minified, cached static files.</p>
<doc-anchor-target id="client-side-library-management-with-libman">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#client-side-library-management-with-libman">#</doc-anchor-trigger>
        <span>Client-Side Library Management with LibMan</span>
    </h4>
</doc-anchor-target>
<p>LibMan (Library Manager) manages client-side dependencies without npm complexity.</p>
<p><strong>libman.json</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
  &quot;version&quot;: &quot;1.0&quot;,
  &quot;defaultProvider&quot;: &quot;cdnjs&quot;,
  &quot;libraries&quot;: [
    {
      &quot;library&quot;: &quot;htmx.org@1.9.10&quot;,
      &quot;destination&quot;: &quot;wwwroot/lib/htmx/&quot;,
      &quot;files&quot;: [
        &quot;htmx.min.js&quot;,
        &quot;htmx.js&quot;
      ]
    },
    {
      &quot;library&quot;: &quot;hyperscript.org@0.9.12&quot;,
      &quot;destination&quot;: &quot;wwwroot/lib/hyperscript/&quot;,
      &quot;files&quot;: [
        &quot;_hyperscript.min.js&quot;,
        &quot;_hyperscript.js&quot;
      ]
    }
  ]
}</code></pre>
</doc-codeblock></div>
<p>Restore libraries during build:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">dotnet tool install -g Microsoft.Web.LibraryManager.Cli
libman restore</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="bundling-and-minification">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#bundling-and-minification">#</doc-anchor-trigger>
        <span>Bundling and Minification</span>
    </h4>
</doc-anchor-target>
<p>For custom CSS and JavaScript, use WebOptimizer or BundlerMinifier:</p>
<p><strong>bundleconfig.json</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">[
  {
    &quot;outputFileName&quot;: &quot;wwwroot/css/site.min.css&quot;,
    &quot;inputFiles&quot;: [
      &quot;wwwroot/css/site.css&quot;,
      &quot;wwwroot/css/htmx-indicators.css&quot;,
      &quot;wwwroot/css/toast.css&quot;
    ],
    &quot;minify&quot;: {
      &quot;enabled&quot;: true,
      &quot;renameLocals&quot;: true
    }
  },
  {
    &quot;outputFileName&quot;: &quot;wwwroot/js/site.min.js&quot;,
    &quot;inputFiles&quot;: [
      &quot;wwwroot/js/htmx-config.js&quot;,
      &quot;wwwroot/js/toast-handler.js&quot;
    ],
    &quot;minify&quot;: {
      &quot;enabled&quot;: true
    }
  }
]</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="static-file-caching">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#static-file-caching">#</doc-anchor-trigger>
        <span>Static File Caching</span>
    </h4>
</doc-anchor-target>
<p>Configure aggressive caching for static files. Fingerprinted assets (with hash in filename) can cache for one year.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
app.UseStaticFiles(new StaticFileOptions
{
    OnPrepareResponse = ctx =&gt;
    {
        // Cache static files for 1 year
        const int durationInSeconds = 60 * 60 * 24 * 365;
        ctx.Context.Response.Headers.Append(
            &quot;Cache-Control&quot;, $&quot;public, max-age={durationInSeconds}&quot;);
    }
});</code></pre>
</doc-codeblock></div>
<p>For versioned files (using asp-append-version tag helper), the cache is automatically invalidated when files change:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">&lt;link rel=&quot;stylesheet&quot; href=&quot;~/css/site.min.css&quot; asp-append-version=&quot;true&quot; /&gt;
&lt;script src=&quot;~/lib/htmx/htmx.min.js&quot; asp-append-version=&quot;true&quot;&gt;&lt;/script&gt;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2323-response-compression">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2323-response-compression">#</doc-anchor-trigger>
        <span>23.2.3 Response Compression</span>
    </h3>
</doc-anchor-target>
<p>Compression reduces bandwidth and improves response times. htmx partial responses benefit even though they&#x27;re small.</p>
<doc-anchor-target id="why-compression-matters-for-htmx">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#why-compression-matters-for-htmx">#</doc-anchor-trigger>
        <span>Why Compression Matters for htmx</span>
    </h4>
</doc-anchor-target>
<p>Consider a typical htmx interaction:</p>
<ul>
<li>Search results partial: 3KB uncompressed → 800 bytes compressed (73% reduction)</li>
<li>Edit form partial: 2KB uncompressed → 500 bytes compressed (75% reduction)</li>
<li>Table row: 500 bytes uncompressed → 180 bytes compressed (64% reduction)</li>
</ul>
<p>Over a session with 50 htmx requests, compression saves significant bandwidth.</p>
<doc-anchor-target id="brotli-vs-gzip">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#brotli-vs-gzip">#</doc-anchor-trigger>
        <span>Brotli vs Gzip</span>
    </h4>
</doc-anchor-target>
<p>Brotli typically achieves 15-20% better compression than Gzip and is supported by all modern browsers. Configure both with Brotli as primary:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs - Add before builder.Build()

builder.Services.AddResponseCompression(options =&gt;
{
    options.EnableForHttps = true;
    options.Providers.Add&lt;BrotliCompressionProvider&gt;();
    options.Providers.Add&lt;GzipCompressionProvider&gt;();
    
    options.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(new[]
    {
        &quot;text/html&quot;,
        &quot;application/json&quot;,
        &quot;text/plain&quot;,
        &quot;text/css&quot;,
        &quot;application/javascript&quot;,
        &quot;text/javascript&quot;,
        &quot;application/xml&quot;,
        &quot;text/xml&quot;
    });
});

builder.Services.Configure&lt;BrotliCompressionProviderOptions&gt;(options =&gt;
{
    options.Level = CompressionLevel.Optimal;
});

builder.Services.Configure&lt;GzipCompressionProviderOptions&gt;(options =&gt;
{
    options.Level = CompressionLevel.Optimal;
});</code></pre>
</doc-codeblock></div>
<p>Enable compression early in the pipeline:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">var app = builder.Build();

// Compression should be early in the pipeline
app.UseResponseCompression();

app.UseHttpsRedirection();
app.UseStaticFiles();
// ... rest of pipeline</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2324-database-considerations">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2324-database-considerations">#</doc-anchor-trigger>
        <span>23.2.4 Database Considerations</span>
    </h3>
</doc-anchor-target>
<p>Production database configuration differs significantly from development.</p>
<doc-anchor-target id="connection-string-format-for-azure-sql">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#connection-string-format-for-azure-sql">#</doc-anchor-trigger>
        <span>Connection String Format for Azure SQL</span>
    </h4>
</doc-anchor-target>
<p>Azure SQL connection strings include additional parameters:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Server=tcp:chinook-server.database.windows.net,1433;
Initial Catalog=ChinookDb;
Persist Security Info=False;
User ID=chinook-admin;
Password={your_password};
MultipleActiveResultSets=False;
Encrypt=True;
TrustServerCertificate=False;
Connection Timeout=30;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="key-vault-references">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#key-vault-references">#</doc-anchor-trigger>
        <span>Key Vault References</span>
    </h4>
</doc-anchor-target>
<p>Instead of storing connection strings directly in App Settings, reference Key Vault:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">@Microsoft.KeyVault(SecretUri=https://chinook-vault.vault.azure.net/secrets/ChinookConnection/)</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="production-dbcontext-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#production-dbcontext-configuration">#</doc-anchor-trigger>
        <span>Production DbContext Configuration</span>
    </h4>
</doc-anchor-target>
<p>Configure Entity Framework for production workloads:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
builder.Services.AddDbContext&lt;ChinookContext&gt;((serviceProvider, options) =&gt;
{
    var connectionString = builder.Configuration.GetConnectionString(&quot;ChinookConnection&quot;);
    
    options.UseSqlServer(connectionString, sqlOptions =&gt;
    {
        // Connection resiliency for transient failures
        sqlOptions.EnableRetryOnFailure(
            maxRetryCount: 5,
            maxRetryDelay: TimeSpan.FromSeconds(30),
            errorNumbersToAdd: null);
        
        // Command timeout for long-running queries
        sqlOptions.CommandTimeout(30);
    });
    
    // Production optimizations
    if (builder.Environment.IsProduction())
    {
        options.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking);
    }
});</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="migration-strategy">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#migration-strategy">#</doc-anchor-trigger>
        <span>Migration Strategy</span>
    </h4>
</doc-anchor-target>
<p>For production deployments, generate SQL scripts rather than running migrations directly:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Generate migration script
dotnet ef migrations script --idempotent --output migrations.sql

# Review the script before applying
# Apply via Azure Portal Query Editor or sqlcmd during deployment</code></pre>
</doc-codeblock></div>
<p>The <code v-pre>--idempotent</code> flag generates scripts that check if migrations have already been applied, making them safe to run multiple times.</p>
<doc-anchor-target id="complete-production-programcs">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#complete-production-programcs">#</doc-anchor-trigger>
        <span>Complete Production Program.cs</span>
    </h3>
</doc-anchor-target>
<p>Here&#x27;s the complete <code v-pre>Program.cs</code> with all production configurations:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using System.IO.Compression;
using Microsoft.AspNetCore.ResponseCompression;
using Microsoft.EntityFrameworkCore;
using ChinookDashboard.Data;
using ChinookDashboard.Services;

var builder = WebApplication.CreateBuilder(args);

// ===== Services Configuration =====

// Response Compression
builder.Services.AddResponseCompression(options =&gt;
{
    options.EnableForHttps = true;
    options.Providers.Add&lt;BrotliCompressionProvider&gt;();
    options.Providers.Add&lt;GzipCompressionProvider&gt;();
    options.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(new[]
    {
        &quot;text/html&quot;,
        &quot;application/json&quot;,
        &quot;text/plain&quot;,
        &quot;text/css&quot;,
        &quot;application/javascript&quot;
    });
});

builder.Services.Configure&lt;BrotliCompressionProviderOptions&gt;(options =&gt;
{
    options.Level = CompressionLevel.Optimal;
});

builder.Services.Configure&lt;GzipCompressionProviderOptions&gt;(options =&gt;
{
    options.Level = CompressionLevel.Optimal;
});

// Database Context
builder.Services.AddDbContext&lt;ChinookContext&gt;((serviceProvider, options) =&gt;
{
    var connectionString = builder.Configuration.GetConnectionString(&quot;ChinookConnection&quot;);
    
    options.UseSqlServer(connectionString, sqlOptions =&gt;
    {
        sqlOptions.EnableRetryOnFailure(
            maxRetryCount: 5,
            maxRetryDelay: TimeSpan.FromSeconds(30),
            errorNumbersToAdd: null);
        sqlOptions.CommandTimeout(30);
    });
    
    if (builder.Environment.IsProduction())
    {
        options.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking);
    }
});

// Application Services
builder.Services.AddScoped&lt;IArtistService, ArtistService&gt;();
builder.Services.AddScoped&lt;IAlbumService, AlbumService&gt;();
builder.Services.AddScoped&lt;ITrackService, TrackService&gt;();

// Razor Pages
builder.Services.AddRazorPages();

// Health Checks
builder.Services.AddHealthChecks()
    .AddDbContextCheck&lt;ChinookContext&gt;(&quot;database&quot;);

// Anti-forgery
builder.Services.AddAntiforgery(options =&gt;
{
    options.HeaderName = &quot;RequestVerificationToken&quot;;
});

var app = builder.Build();

// ===== Middleware Pipeline =====

// Response compression (early in pipeline)
app.UseResponseCompression();

// Error handling
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler(&quot;/Error&quot;);
    app.UseHsts();
}

app.UseHttpsRedirection();

// Static files with caching
app.UseStaticFiles(new StaticFileOptions
{
    OnPrepareResponse = ctx =&gt;
    {
        var cacheMaxAge = builder.Configuration.GetValue&lt;int&gt;(&quot;Caching:StaticFilesCacheMaxAge&quot;, 86400);
        ctx.Context.Response.Headers.Append(&quot;Cache-Control&quot;, $&quot;public, max-age={cacheMaxAge}&quot;);
    }
});

app.UseRouting();
app.UseAuthorization();

// Health check endpoint
app.MapHealthChecks(&quot;/health&quot;);

app.MapRazorPages();

app.Run();</code></pre>
</doc-codeblock></div>
<hr>
<doc-anchor-target id="233-setting-up-azure-resources">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#233-setting-up-azure-resources">#</doc-anchor-trigger>
        <span>23.3 Setting Up Azure Resources</span>
    </h2>
</doc-anchor-target>
<p>With the application prepared, create the Azure infrastructure to host it.</p>
<doc-anchor-target id="2331-azure-app-service-setup">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2331-azure-app-service-setup">#</doc-anchor-trigger>
        <span>23.3.1 Azure App Service Setup</span>
    </h3>
</doc-anchor-target>
<p>Azure App Service provides managed hosting for web applications. Choose the right tier based on your needs:</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Tier</th>
<th>Use Case</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>F1 (Free)</td>
<td>Testing only</td>
<td>60 min/day compute, no custom domain</td>
</tr>
<tr>
<td>B1 (Basic)</td>
<td>Dev/Test</td>
<td>Custom domain, manual scale</td>
</tr>
<tr>
<td>P1v3 (Premium)</td>
<td>Production</td>
<td>Auto-scale, deployment slots, more CPU/RAM</td>
</tr>
</tbody>
</table>
</div>
<p>For production htmx applications, P1v3 provides deployment slots for zero-downtime deployments and auto-scaling for traffic spikes.</p>
<doc-anchor-target id="azure-cli-setup-script">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-cli-setup-script">#</doc-anchor-trigger>
        <span>Azure CLI Setup Script</span>
    </h4>
</doc-anchor-target>
<p>Create a script to provision all resources:</p>
<p><strong>infrastructure/azure-setup.sh</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">#!/bin/bash

# ============================================
# Azure Resource Setup for Chinook Dashboard
# ============================================

# Configuration - Change these values
RESOURCE_GROUP=&quot;chinook-rg&quot;
LOCATION=&quot;eastus&quot;
APP_SERVICE_PLAN=&quot;chinook-plan&quot;
WEB_APP_NAME=&quot;chinook-dashboard&quot;  # Must be globally unique
SQL_SERVER_NAME=&quot;chinook-sql&quot;     # Must be globally unique
SQL_DATABASE_NAME=&quot;ChinookDb&quot;
SQL_ADMIN_USER=&quot;chinook-admin&quot;
KEY_VAULT_NAME=&quot;chinook-vault&quot;    # Must be globally unique

# Prompt for SQL password (don't hardcode!)
echo &quot;Enter SQL Admin Password (min 8 chars, requires uppercase, lowercase, number):&quot;
read -s SQL_ADMIN_PASSWORD

echo &quot;&quot;
echo &quot;Starting Azure resource provisioning...&quot;
echo &quot;========================================&quot;

# ============================================
# 1. Resource Group
# ============================================
echo &quot;Creating resource group...&quot;
az group create \
    --name $RESOURCE_GROUP \
    --location $LOCATION \
    --output none

echo &quot;✓ Resource group created: $RESOURCE_GROUP&quot;

# ============================================
# 2. App Service Plan
# ============================================
echo &quot;Creating App Service Plan...&quot;
az appservice plan create \
    --name $APP_SERVICE_PLAN \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --sku P1V3 \
    --is-linux false \
    --output none

echo &quot;✓ App Service Plan created: $APP_SERVICE_PLAN (P1V3)&quot;

# ============================================
# 3. Web App
# ============================================
echo &quot;Creating Web App...&quot;
az webapp create \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --plan $APP_SERVICE_PLAN \
    --runtime &quot;dotnet:8&quot; \
    --output none

echo &quot;✓ Web App created: $WEB_APP_NAME&quot;

# Configure Web App settings
echo &quot;Configuring Web App settings...&quot;
az webapp config set \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --always-on true \
    --http20-enabled true \
    --min-tls-version 1.2 \
    --ftps-state Disabled \
    --output none

# Enable system-assigned managed identity
az webapp identity assign \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --output none

echo &quot;✓ Web App configured with Always On, HTTP/2, TLS 1.2&quot;

# ============================================
# 4. Deployment Slot (Staging)
# ============================================
echo &quot;Creating staging deployment slot...&quot;
az webapp deployment slot create \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --slot staging \
    --output none

# Configure staging slot
az webapp config set \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --slot staging \
    --always-on true \
    --output none

echo &quot;✓ Staging slot created&quot;

# ============================================
# 5. SQL Server
# ============================================
echo &quot;Creating SQL Server...&quot;
az sql server create \
    --name $SQL_SERVER_NAME \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --admin-user $SQL_ADMIN_USER \
    --admin-password &quot;$SQL_ADMIN_PASSWORD&quot; \
    --output none

echo &quot;✓ SQL Server created: $SQL_SERVER_NAME&quot;

# Configure firewall to allow Azure services
echo &quot;Configuring SQL Server firewall...&quot;
az sql server firewall-rule create \
    --server $SQL_SERVER_NAME \
    --resource-group $RESOURCE_GROUP \
    --name AllowAzureServices \
    --start-ip-address 0.0.0.0 \
    --end-ip-address 0.0.0.0 \
    --output none

echo &quot;✓ SQL Server firewall configured for Azure services&quot;

# ============================================
# 6. SQL Database
# ============================================
echo &quot;Creating SQL Database...&quot;
az sql db create \
    --name $SQL_DATABASE_NAME \
    --resource-group $RESOURCE_GROUP \
    --server $SQL_SERVER_NAME \
    --service-objective S0 \
    --backup-storage-redundancy Local \
    --output none

echo &quot;✓ SQL Database created: $SQL_DATABASE_NAME (Standard S0)&quot;

# ============================================
# 7. Key Vault
# ============================================
echo &quot;Creating Key Vault...&quot;
az keyvault create \
    --name $KEY_VAULT_NAME \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --enable-rbac-authorization false \
    --output none

echo &quot;✓ Key Vault created: $KEY_VAULT_NAME&quot;

# Get Web App's managed identity
WEB_APP_IDENTITY=$(az webapp identity show \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --query principalId \
    --output tsv)

# Grant Web App access to Key Vault secrets
az keyvault set-policy \
    --name $KEY_VAULT_NAME \
    --object-id $WEB_APP_IDENTITY \
    --secret-permissions get list \
    --output none

echo &quot;✓ Key Vault access policy set for Web App&quot;

# ============================================
# 8. Store Connection String in Key Vault
# ============================================
echo &quot;Storing connection string in Key Vault...&quot;

CONNECTION_STRING=&quot;Server=tcp:${SQL_SERVER_NAME}.database.windows.net,1433;Initial Catalog=${SQL_DATABASE_NAME};Persist Security Info=False;User ID=${SQL_ADMIN_USER};Password=${SQL_ADMIN_PASSWORD};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;&quot;

az keyvault secret set \
    --vault-name $KEY_VAULT_NAME \
    --name &quot;ChinookConnection&quot; \
    --value &quot;$CONNECTION_STRING&quot; \
    --output none

echo &quot;✓ Connection string stored in Key Vault&quot;

# ============================================
# 9. Configure Web App Connection String
# ============================================
echo &quot;Configuring Web App to use Key Vault reference...&quot;

KEY_VAULT_REFERENCE=&quot;@Microsoft.KeyVault(SecretUri=https://${KEY_VAULT_NAME}.vault.azure.net/secrets/ChinookConnection/)&quot;

az webapp config connection-string set \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --connection-string-type SQLAzure \
    --settings ChinookConnection=&quot;$KEY_VAULT_REFERENCE&quot; \
    --output none

# Also set for staging slot
az webapp config connection-string set \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --slot staging \
    --connection-string-type SQLAzure \
    --settings ChinookConnection=&quot;$KEY_VAULT_REFERENCE&quot; \
    --output none

echo &quot;✓ Web App configured with Key Vault reference&quot;

# ============================================
# 10. Configure App Settings
# ============================================
echo &quot;Setting application configuration...&quot;

az webapp config appsettings set \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --settings \
        ASPNETCORE_ENVIRONMENT=Production \
        Logging__LogLevel__Default=Information \
        Logging__LogLevel__Microsoft.AspNetCore=Warning \
    --output none

echo &quot;✓ App settings configured&quot;

# ============================================
# Summary
# ============================================
echo &quot;&quot;
echo &quot;========================================&quot;
echo &quot;Azure Resource Setup Complete!&quot;
echo &quot;========================================&quot;
echo &quot;&quot;
echo &quot;Resources created:&quot;
echo &quot;  • Resource Group: $RESOURCE_GROUP&quot;
echo &quot;  • App Service Plan: $APP_SERVICE_PLAN (P1V3)&quot;
echo &quot;  • Web App: $WEB_APP_NAME&quot;
echo &quot;  • Staging Slot: $WEB_APP_NAME/staging&quot;
echo &quot;  • SQL Server: $SQL_SERVER_NAME.database.windows.net&quot;
echo &quot;  • SQL Database: $SQL_DATABASE_NAME&quot;
echo &quot;  • Key Vault: $KEY_VAULT_NAME&quot;
echo &quot;&quot;
echo &quot;Web App URLs:&quot;
echo &quot;  • Production: https://${WEB_APP_NAME}.azurewebsites.net&quot;
echo &quot;  • Staging: https://${WEB_APP_NAME}-staging.azurewebsites.net&quot;
echo &quot;&quot;
echo &quot;Next steps:&quot;
echo &quot;  1. Run database migrations against $SQL_SERVER_NAME&quot;
echo &quot;  2. Configure GitHub Actions with deployment credentials&quot;
echo &quot;  3. Deploy your application&quot;
echo &quot;&quot;</code></pre>
</doc-codeblock></div>
<p>Make the script executable and run it:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">chmod +x infrastructure/azure-setup.sh
./infrastructure/azure-setup.sh</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2332-azure-sql-database-setup">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2332-azure-sql-database-setup">#</doc-anchor-trigger>
        <span>23.3.2 Azure SQL Database Setup</span>
    </h3>
</doc-anchor-target>
<p>The setup script creates the database, but you may need additional configuration.</p>
<doc-anchor-target id="connection-string-format">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#connection-string-format">#</doc-anchor-trigger>
        <span>Connection String Format</span>
    </h4>
</doc-anchor-target>
<p>The complete connection string for Azure SQL:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Server=tcp:chinook-sql.database.windows.net,1433;
Initial Catalog=ChinookDb;
Persist Security Info=False;
User ID=chinook-admin;
Password={your_password};
MultipleActiveResultSets=False;
Encrypt=True;
TrustServerCertificate=False;
Connection Timeout=30;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="firewall-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#firewall-configuration">#</doc-anchor-trigger>
        <span>Firewall Configuration</span>
    </h4>
</doc-anchor-target>
<p>The script allows Azure services. To connect from your local machine for migrations:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Get your current IP
MY_IP=$(curl -s ifconfig.me)

# Add firewall rule
az sql server firewall-rule create \
    --server chinook-sql \
    --resource-group chinook-rg \
    --name MyLocalIP \
    --start-ip-address $MY_IP \
    --end-ip-address $MY_IP</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="running-migrations">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#running-migrations">#</doc-anchor-trigger>
        <span>Running Migrations</span>
    </h4>
</doc-anchor-target>
<p>Apply migrations to the production database:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Generate idempotent script
dotnet ef migrations script --idempotent --output migrations.sql

# Apply using sqlcmd
sqlcmd -S chinook-sql.database.windows.net \
       -d ChinookDb \
       -U chinook-admin \
       -P 'YourPassword' \
       -i migrations.sql</code></pre>
</doc-codeblock></div>
<p>Or use the Azure Portal Query Editor for smaller scripts.</p>
<doc-anchor-target id="2333-application-settings-and-connection-strings">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2333-application-settings-and-connection-strings">#</doc-anchor-trigger>
        <span>23.3.3 Application Settings and Connection Strings</span>
    </h3>
</doc-anchor-target>
<p>Azure App Settings override <code v-pre>appsettings.json</code> values. Configure them via CLI or Portal.</p>
<doc-anchor-target id="setting-app-settings-via-cli">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#setting-app-settings-via-cli">#</doc-anchor-trigger>
        <span>Setting App Settings via CLI</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Set multiple settings at once
az webapp config appsettings set \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --settings \
        ASPNETCORE_ENVIRONMENT=Production \
        ApplicationInsights__ConnectionString=&quot;InstrumentationKey=xxx&quot; \
        Htmx__Timeout=30000 \
        FeatureFlags__EnableSwagger=false</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="key-vault-references-1">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#key-vault-references-1">#</doc-anchor-trigger>
        <span>Key Vault References</span>
    </h4>
</doc-anchor-target>
<p>For sensitive values, use Key Vault references instead of plain text:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Store secret in Key Vault
az keyvault secret set \
    --vault-name chinook-vault \
    --name &quot;AppInsightsKey&quot; \
    --value &quot;your-instrumentation-key&quot;

# Reference in App Settings
az webapp config appsettings set \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --settings \
        ApplicationInsights__ConnectionString=&quot;@Microsoft.KeyVault(SecretUri=https://chinook-vault.vault.azure.net/secrets/AppInsightsKey/)&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="slot-settings">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#slot-settings">#</doc-anchor-trigger>
        <span>Slot Settings</span>
    </h4>
</doc-anchor-target>
<p>Some settings should differ between production and staging slots. Mark them as slot settings:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Make setting &quot;sticky&quot; to its slot
az webapp config appsettings set \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --slot-settings \
        IsStaging=false

az webapp config appsettings set \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --slot staging \
    --slot-settings \
        IsStaging=true</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2334-custom-domain-and-ssl">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2334-custom-domain-and-ssl">#</doc-anchor-trigger>
        <span>23.3.4 Custom Domain and SSL</span>
    </h3>
</doc-anchor-target>
<p>Add a custom domain to your App Service.</p>
<doc-anchor-target id="prerequisites">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#prerequisites">#</doc-anchor-trigger>
        <span>Prerequisites</span>
    </h4>
</doc-anchor-target>
<ol>
<li>Own a domain (e.g., <code v-pre>chinook.example.com</code>)</li>
<li>Access to DNS management for that domain</li>
</ol>
<doc-anchor-target id="dns-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#dns-configuration">#</doc-anchor-trigger>
        <span>DNS Configuration</span>
    </h4>
</doc-anchor-target>
<p>Add a CNAME record pointing to your App Service:</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Type</th>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CNAME</td>
<td>chinook</td>
<td>chinook-dashboard.azurewebsites.net</td>
</tr>
</tbody>
</table>
</div>
<p>Or for apex domains (example.com without subdomain), use an A record with Azure&#x27;s IP and a TXT record for verification.</p>
<doc-anchor-target id="complete-custom-domain-setup-script">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#complete-custom-domain-setup-script">#</doc-anchor-trigger>
        <span>Complete Custom Domain Setup Script</span>
    </h4>
</doc-anchor-target>
<p><strong>infrastructure/setup-domain.sh</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">#!/bin/bash

# Configuration
RESOURCE_GROUP=&quot;chinook-rg&quot;
WEB_APP_NAME=&quot;chinook-dashboard&quot;
CUSTOM_DOMAIN=&quot;chinook.example.com&quot;

echo &quot;Setting up custom domain: $CUSTOM_DOMAIN&quot;
echo &quot;=========================================&quot;

# ============================================
# 1. Add Custom Domain
# ============================================
echo &quot;Adding custom domain to Web App...&quot;
echo &quot;NOTE: Ensure DNS CNAME record exists first!&quot;
echo &quot;  CNAME: chinook -&gt; ${WEB_APP_NAME}.azurewebsites.net&quot;
echo &quot;&quot;

read -p &quot;DNS configured? (y/n): &quot; DNS_READY
if [ &quot;$DNS_READY&quot; != &quot;y&quot; ]; then
    echo &quot;Please configure DNS first, then re-run this script.&quot;
    exit 1
fi

az webapp config hostname add \
    --webapp-name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --hostname $CUSTOM_DOMAIN \
    --output none

echo &quot;✓ Custom domain added&quot;

# ============================================
# 2. Create Managed SSL Certificate
# ============================================
echo &quot;Creating managed SSL certificate...&quot;

az webapp config ssl create \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --hostname $CUSTOM_DOMAIN \
    --output none

echo &quot;✓ SSL certificate created (may take a few minutes to provision)&quot;

# ============================================
# 3. Bind SSL Certificate
# ============================================
echo &quot;Binding SSL certificate to domain...&quot;

# Get the certificate thumbprint
THUMBPRINT=$(az webapp config ssl list \
    --resource-group $RESOURCE_GROUP \
    --query &quot;[?subjectName=='$CUSTOM_DOMAIN'].thumbprint&quot; \
    --output tsv)

if [ -z &quot;$THUMBPRINT&quot; ]; then
    echo &quot;Certificate not ready yet. Check Azure Portal in a few minutes.&quot;
else
    az webapp config ssl bind \
        --name $WEB_APP_NAME \
        --resource-group $RESOURCE_GROUP \
        --certificate-thumbprint $THUMBPRINT \
        --ssl-type SNI \
        --output none
    
    echo &quot;✓ SSL certificate bound&quot;
fi

# ============================================
# 4. Enforce HTTPS
# ============================================
echo &quot;Enforcing HTTPS redirect...&quot;

az webapp update \
    --name $WEB_APP_NAME \
    --resource-group $RESOURCE_GROUP \
    --https-only true \
    --output none

echo &quot;✓ HTTPS-only mode enabled&quot;

# ============================================
# Summary
# ============================================
echo &quot;&quot;
echo &quot;========================================&quot;
echo &quot;Custom Domain Setup Complete!&quot;
echo &quot;========================================&quot;
echo &quot;&quot;
echo &quot;Your site is now available at:&quot;
echo &quot;  https://$CUSTOM_DOMAIN&quot;
echo &quot;&quot;
echo &quot;Note: SSL certificate provisioning may take up to 15 minutes.&quot;
echo &quot;Check the Azure Portal if the certificate doesn't appear immediately.&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="enforcing-https-in-application">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#enforcing-https-in-application">#</doc-anchor-trigger>
        <span>Enforcing HTTPS in Application</span>
    </h4>
</doc-anchor-target>
<p>Even with Azure&#x27;s HTTPS-only setting, add middleware for defense in depth:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
if (!app.Environment.IsDevelopment())
{
    app.UseHsts();
}

app.UseHttpsRedirection();</code></pre>
</doc-codeblock></div>
<p>Configure HSTS properly:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">builder.Services.AddHsts(options =&gt;
{
    options.Preload = true;
    options.IncludeSubDomains = true;
    options.MaxAge = TimeSpan.FromDays(365);
});</code></pre>
</doc-codeblock></div>
<p>With the Azure resources provisioned and the application configured for production, you&#x27;re ready to set up automated deployments with GitHub Actions in the next section.</p>
<doc-anchor-target id="234-github-actions-cicd-pipeline">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#234-github-actions-cicd-pipeline">#</doc-anchor-trigger>
        <span>23.4 GitHub Actions CI/CD Pipeline</span>
    </h2>
</doc-anchor-target>
<p>Automated deployment pipelines eliminate manual deployment steps, reduce errors, and enable rapid iteration. GitHub Actions integrates directly with your repository to build, test, and deploy on every commit.</p>
<doc-anchor-target id="2341-understanding-github-actions">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2341-understanding-github-actions">#</doc-anchor-trigger>
        <span>23.4.1 Understanding GitHub Actions</span>
    </h3>
</doc-anchor-target>
<p>GitHub Actions uses YAML files in the <code v-pre>.github/workflows</code> directory to define automation workflows.</p>
<doc-anchor-target id="workflow-structure">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#workflow-structure">#</doc-anchor-trigger>
        <span>Workflow Structure</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">name: Workflow Name              # Display name in GitHub UI

on:                              # Triggers
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:                             # Environment variables for all jobs
  DOTNET_VERSION: '8.0.x'

jobs:                            # One or more jobs
  build:                         # Job ID
    runs-on: ubuntu-latest       # Runner type
    
    steps:                       # Sequential steps
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="trigger-types">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#trigger-types">#</doc-anchor-trigger>
        <span>Trigger Types</span>
    </h4>
</doc-anchor-target>
<p><strong>push</strong>: Runs when commits are pushed to specified branches</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'</code></pre>
</doc-codeblock></div>
<p><strong>pull_request</strong>: Runs when PRs target specified branches</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">on:
  pull_request:
    branches: [main]</code></pre>
</doc-codeblock></div>
<p><strong>workflow_dispatch</strong>: Allows manual triggering from GitHub UI</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="github-secrets">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#github-secrets">#</doc-anchor-trigger>
        <span>GitHub Secrets</span>
    </h4>
</doc-anchor-target>
<p>Store sensitive values in repository or organization secrets:</p>
<ol>
<li>Navigate to repository Settings → Secrets and variables → Actions</li>
<li>Add secrets like <code v-pre>AZURE_CREDENTIALS</code>, <code v-pre>SQL_CONNECTION_STRING</code></li>
<li>Reference in workflows: <code v-pre>${{ ERROR }}</code></li>
</ol>
<doc-anchor-target id="environments-for-deployment-approvals">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#environments-for-deployment-approvals">#</doc-anchor-trigger>
        <span>Environments for Deployment Approvals</span>
    </h4>
</doc-anchor-target>
<p>Create environments with protection rules:</p>
<ol>
<li>Settings → Environments → New environment</li>
<li>Add required reviewers for production deployments</li>
<li>Reference in workflow: <code v-pre>environment: production</code></li>
</ol>
<doc-anchor-target id="2342-basic-build-and-test-workflow">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2342-basic-build-and-test-workflow">#</doc-anchor-trigger>
        <span>23.4.2 Basic Build and Test Workflow</span>
    </h3>
</doc-anchor-target>
<p>Start with a workflow that builds and tests on every push and pull request.</p>
<p><strong>.github/workflows/build-test.yml</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">name: Build and Test

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'ChinookDashboard.sln'
  TEST_PROJECT_PATH: 'ChinookDashboard.Tests/ChinookDashboard.Tests.csproj'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ ERROR }}

      - name: Build
        run: dotnet build ${{ ERROR }} --no-restore --configuration Release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/bin/Release/net8.0/
            !**/bin/Release/net8.0/publish/
          retention-days: 1

  test-unit:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ ERROR }}

      - name: Run unit tests
        run: |
          dotnet test ${{ ERROR }} \
            --no-restore \
            --configuration Release \
            --filter &quot;FullyQualifiedName~Unit&quot; \
            --logger &quot;trx;LogFileName=unit-test-results.trx&quot; \
            --results-directory ./TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: ./TestResults/*.trx
          retention-days: 7

  test-integration:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ ERROR }}

      - name: Run integration tests
        run: |
          dotnet test ${{ ERROR }} \
            --no-restore \
            --configuration Release \
            --filter &quot;FullyQualifiedName~Integration&quot; \
            --logger &quot;trx;LogFileName=integration-test-results.trx&quot; \
            --results-directory ./TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: ./TestResults/*.trx
          retention-days: 7

  test-browser:
    name: Browser Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ ERROR }}

      - name: Build test project
        run: dotnet build ${{ ERROR }} --no-restore --configuration Release

      - name: Install Playwright browsers
        run: pwsh ChinookDashboard.Tests/bin/Release/net8.0/playwright.ps1 install --with-deps chromium

      - name: Run browser tests
        run: |
          dotnet test ${{ ERROR }} \
            --no-build \
            --configuration Release \
            --filter &quot;FullyQualifiedName~Browser&quot; \
            --logger &quot;trx;LogFileName=browser-test-results.trx&quot; \
            --results-directory ./TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: browser-test-results
          path: ./TestResults/*.trx
          retention-days: 7

      - name: Upload Playwright traces
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces
          path: '**/TestResults/Traces/'
          retention-days: 7</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2343-deployment-workflow">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2343-deployment-workflow">#</doc-anchor-trigger>
        <span>23.4.3 Deployment Workflow</span>
    </h3>
</doc-anchor-target>
<p>To deploy to Azure, create a service principal and store its credentials as a GitHub secret.</p>
<doc-anchor-target id="creating-azure-service-principal">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#creating-azure-service-principal">#</doc-anchor-trigger>
        <span>Creating Azure Service Principal</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">#!/bin/bash
# create-service-principal.sh

SUBSCRIPTION_ID=$(az account show --query id -o tsv)
RESOURCE_GROUP=&quot;chinook-rg&quot;
APP_NAME=&quot;chinook-dashboard&quot;

# Create service principal with contributor access to resource group
az ad sp create-for-rbac \
    --name &quot;github-actions-$APP_NAME&quot; \
    --role contributor \
    --scopes /subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP \
    --sdk-auth

# Output looks like:
# {
#   &quot;clientId&quot;: &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,
#   &quot;clientSecret&quot;: &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;,
#   &quot;subscriptionId&quot;: &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,
#   &quot;tenantId&quot;: &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,
#   ...
# }
#
# Copy this entire JSON output and save as GitHub secret: AZURE_CREDENTIALS</code></pre>
</doc-codeblock></div>
<p>Save the JSON output as a GitHub secret named <code v-pre>AZURE_CREDENTIALS</code>.</p>
<doc-anchor-target id="basic-deployment-workflow">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#basic-deployment-workflow">#</doc-anchor-trigger>
        <span>Basic Deployment Workflow</span>
    </h4>
</doc-anchor-target>
<p><strong>.github/workflows/deploy.yml</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: chinook-dashboard
  AZURE_RESOURCE_GROUP: chinook-rg
  PROJECT_PATH: 'ChinookDashboard/ChinookDashboard.csproj'

jobs:
  deploy:
    name: Deploy to ${{ ERROR }}
    runs-on: ubuntu-latest
    environment: ${{ ERROR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ ERROR }}

      - name: Build
        run: dotnet build ${{ ERROR }} --no-restore --configuration Release

      - name: Publish
        run: |
          dotnet publish ${{ ERROR }} \
            --no-build \
            --configuration Release \
            --output ./publish

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ ERROR }}

      - name: Deploy to Staging Slot
        if: github.event.inputs.environment == 'staging'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ ERROR }}
          slot-name: staging
          package: ./publish

      - name: Deploy to Production
        if: github.event.inputs.environment == 'production'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ ERROR }}
          package: ./publish

      - name: Logout from Azure
        if: always()
        run: az logout</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2344-complete-cicd-pipeline">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2344-complete-cicd-pipeline">#</doc-anchor-trigger>
        <span>23.4.4 Complete CI/CD Pipeline</span>
    </h3>
</doc-anchor-target>
<p>Combine building, testing, and deployment into a single pipeline with proper stage dependencies and approvals.</p>
<p><strong>.github/workflows/azure-deploy.yml</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: chinook-dashboard
  AZURE_RESOURCE_GROUP: chinook-rg
  PROJECT_PATH: 'ChinookDashboard/ChinookDashboard.csproj'
  TEST_PROJECT_PATH: 'ChinookDashboard.Tests/ChinookDashboard.Tests.csproj'

# Prevent concurrent deployments to same environment
concurrency:
  group: ${{ ERROR }}-${{ ERROR }}
  cancel-in-progress: false

jobs:
  # ==========================================
  # BUILD
  # ==========================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    outputs:
      artifact-name: ${{ ERROR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Publish application
        run: |
          dotnet publish ${{ ERROR }} \
            --no-build \
            --configuration Release \
            --output ./publish

      - name: Set artifact name
        id: set-artifact-name
        run: echo &quot;name=app-${{ ERROR }}-${{ ERROR }}&quot; &gt;&gt; $GITHUB_OUTPUT

      - name: Upload application artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ ERROR }}
          path: ./publish
          retention-days: 3

  # ==========================================
  # TEST
  # ==========================================
  test:
    name: Run Tests
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ ERROR }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ ERROR }}-nuget-${{ ERROR }}
          restore-keys: |
            ${{ ERROR }}-nuget-

      - name: Restore test project
        run: dotnet restore ${{ ERROR }}

      - name: Build test project
        run: dotnet build ${{ ERROR }} --no-restore --configuration Release

      - name: Run unit tests
        run: |
          dotnet test ${{ ERROR }} \
            --no-build \
            --configuration Release \
            --filter &quot;FullyQualifiedName~Unit&quot; \
            --logger &quot;trx;LogFileName=unit-tests.trx&quot; \
            --results-directory ./TestResults

      - name: Run integration tests
        run: |
          dotnet test ${{ ERROR }} \
            --no-build \
            --configuration Release \
            --filter &quot;FullyQualifiedName~Integration&quot; \
            --logger &quot;trx;LogFileName=integration-tests.trx&quot; \
            --results-directory ./TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: ./TestResults/*.trx
          retention-days: 7

  # ==========================================
  # DEPLOY TO STAGING
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    needs: [build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://${{ ERROR }}-staging.azurewebsites.net
    
    steps:
      - name: Download application artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ ERROR }}
          path: ./publish

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ ERROR }}

      - name: Deploy to staging slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ ERROR }}
          slot-name: staging
          package: ./publish

      - name: Verify staging deployment
        run: |
          echo &quot;Waiting for staging to be ready...&quot;
          sleep 30
          
          HEALTH_URL=&quot;https://${{ ERROR }}-staging.azurewebsites.net/health&quot;
          HTTP_STATUS=$(curl -s -o /dev/null -w &quot;%{http_code}&quot; $HEALTH_URL)
          
          if [ $HTTP_STATUS -eq 200 ]; then
            echo &quot;✓ Staging deployment healthy&quot;
          else
            echo &quot;✗ Staging health check failed: HTTP $HTTP_STATUS&quot;
            exit 1
          fi

      - name: Logout from Azure
        if: always()
        run: az logout

  # ==========================================
  # DEPLOY TO PRODUCTION
  # ==========================================
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://${{ ERROR }}.azurewebsites.net
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ ERROR }}

      - name: Swap staging to production
        run: |
          az webapp deployment slot swap \
            --name ${{ ERROR }} \
            --resource-group ${{ ERROR }} \
            --slot staging \
            --target-slot production

      - name: Verify production deployment
        run: |
          echo &quot;Waiting for production to stabilize...&quot;
          sleep 30
          
          HEALTH_URL=&quot;https://${{ ERROR }}.azurewebsites.net/health&quot;
          HTTP_STATUS=$(curl -s -o /dev/null -w &quot;%{http_code}&quot; $HEALTH_URL)
          
          if [ $HTTP_STATUS -eq 200 ]; then
            echo &quot;✓ Production deployment healthy&quot;
          else
            echo &quot;✗ Production health check failed: HTTP $HTTP_STATUS&quot;
            echo &quot;Consider rolling back with slot swap&quot;
            exit 1
          fi

      - name: Logout from Azure
        if: always()
        run: az logout

  # ==========================================
  # ROLLBACK (Manual trigger only)
  # ==========================================
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ ERROR }}

      - name: Swap production back to staging
        run: |
          echo &quot;Rolling back production...&quot;
          az webapp deployment slot swap \
            --name ${{ ERROR }} \
            --resource-group ${{ ERROR }} \
            --slot production \
            --target-slot staging
          echo &quot;✓ Rollback complete&quot;

      - name: Logout from Azure
        if: always()
        run: az logout</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2345-database-migrations-in-cicd">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2345-database-migrations-in-cicd">#</doc-anchor-trigger>
        <span>23.4.5 Database Migrations in CI/CD</span>
    </h3>
</doc-anchor-target>
<p>Apply database migrations during deployment using generated SQL scripts.</p>
<doc-anchor-target id="migration-step-in-build-job">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#migration-step-in-build-job">#</doc-anchor-trigger>
        <span>Migration Step in Build Job</span>
    </h4>
</doc-anchor-target>
<p>Add migration script generation to the build job:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml"># Add to the build job after 'Publish application' step

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Generate migration script
        run: |
          dotnet ef migrations script \
            --idempotent \
            --project ${{ ERROR }} \
            --output ./publish/migrations.sql
        env:
          # Use a dummy connection string for script generation
          ConnectionStrings__ChinookConnection: &quot;Server=.;Database=Dummy;Trusted_Connection=True;&quot;

      - name: Upload migration script
        uses: actions/upload-artifact@v4
        with:
          name: migration-script
          path: ./publish/migrations.sql
          retention-days: 7</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="migration-job">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#migration-job">#</doc-anchor-trigger>
        <span>Migration Job</span>
    </h4>
</doc-anchor-target>
<p>Add a separate job to apply migrations before deployment:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">  # Add after 'test' job, before 'deploy-staging'
  
  migrate-staging:
    name: Apply Migrations (Staging)
    needs: [build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: Download migration script
        uses: actions/download-artifact@v4
        with:
          name: migration-script
          path: ./migrations

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ ERROR }}

      - name: Apply migrations to staging database
        run: |
          # Get connection string from Key Vault
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name chinook-vault \
            --name ChinookConnection \
            --query value -o tsv)
          
          # Extract server, database, user, password from connection string
          SERVER=$(echo $CONNECTION_STRING | grep -oP 'Server=tcp:\K[^,]+')
          DATABASE=$(echo $CONNECTION_STRING | grep -oP 'Initial Catalog=\K[^;]+')
          USER=$(echo $CONNECTION_STRING | grep -oP 'User ID=\K[^;]+')
          PASSWORD=$(echo $CONNECTION_STRING | grep -oP 'Password=\K[^;]+')
          
          # Apply migrations using sqlcmd
          sqlcmd -S $SERVER -d $DATABASE -U $USER -P &quot;$PASSWORD&quot; -i ./migrations/migrations.sql
          
          echo &quot;✓ Migrations applied successfully&quot;

      - name: Logout from Azure
        if: always()
        run: az logout</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="rollback-considerations">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#rollback-considerations">#</doc-anchor-trigger>
        <span>Rollback Considerations</span>
    </h4>
</doc-anchor-target>
<p>For migration rollbacks, maintain down migration scripts or use point-in-time restore:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Generate down migration script (if needed)
dotnet ef migrations script \
    CurrentMigration \
    PreviousMigration \
    --output rollback.sql

# Or use Azure SQL point-in-time restore
az sql db restore \
    --dest-name ChinookDb-Restored \
    --name ChinookDb \
    --resource-group chinook-rg \
    --server chinook-sql \
    --time &quot;2024-01-15T10:00:00Z&quot;</code></pre>
</doc-codeblock></div>
<hr>
<doc-anchor-target id="235-htmx-specific-deployment-considerations">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#235-htmx-specific-deployment-considerations">#</doc-anchor-trigger>
        <span>23.5 htmx-Specific Deployment Considerations</span>
    </h2>
</doc-anchor-target>
<p>htmx applications have unique deployment considerations around caching, error handling, and health checks.</p>
<doc-anchor-target id="2351-caching-strategies-for-partial-responses">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2351-caching-strategies-for-partial-responses">#</doc-anchor-trigger>
        <span>23.5.1 Caching Strategies for Partial Responses</span>
    </h3>
</doc-anchor-target>
<p>Not all htmx responses should be cached. Consider the content type:</p>
<p><strong>Cache these (static or slowly changing):</strong></p>
<ul>
<li>Genre dropdown options</li>
<li>Navigation menus</li>
<li>Static lookup lists</li>
<li>Rarely updated reference data</li>
</ul>
<p><strong>Don&#x27;t cache these:</strong></p>
<ul>
<li>User-specific content</li>
<li>Search results</li>
<li>Real-time data (stats, counts)</li>
<li>Form submissions</li>
<li>Anything with user context</li>
</ul>
<doc-anchor-target id="htmxresponsecachingmiddleware">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#htmxresponsecachingmiddleware">#</doc-anchor-trigger>
        <span>HtmxResponseCachingMiddleware</span>
    </h4>
</doc-anchor-target>
<p><strong>Middleware/HtmxResponseCachingMiddleware.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using Microsoft.Extensions.Options;

namespace ChinookDashboard.Middleware;

public class HtmxCacheOptions
{
    public Dictionary&lt;string, CacheProfile&gt; Profiles { get; set; } = new();
    public int DefaultMaxAge { get; set; } = 0;
    public bool VaryByHxRequest { get; set; } = true;
}

public class CacheProfile
{
    public int MaxAge { get; set; }
    public bool IsPrivate { get; set; }
    public bool NoStore { get; set; }
    public string[]? VaryByQueryKeys { get; set; }
}

public class HtmxResponseCachingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly HtmxCacheOptions _options;
    private readonly ILogger&lt;HtmxResponseCachingMiddleware&gt; _logger;

    public HtmxResponseCachingMiddleware(
        RequestDelegate next,
        IOptions&lt;HtmxCacheOptions&gt; options,
        ILogger&lt;HtmxResponseCachingMiddleware&gt; logger)
    {
        _next = next;
        _options = options.Value;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // Only process htmx requests
        if (!IsHtmxRequest(context))
        {
            await _next(context);
            return;
        }

        // Get cache profile for this handler
        var profile = GetCacheProfile(context);

        // Add Vary header for htmx requests
        if (_options.VaryByHxRequest)
        {
            context.Response.Headers.Append(&quot;Vary&quot;, &quot;HX-Request&quot;);
        }

        if (profile != null)
        {
            SetCacheHeaders(context, profile);
        }
        else
        {
            // Default: no caching for htmx responses
            SetNoCacheHeaders(context);
        }

        await _next(context);
    }

    private static bool IsHtmxRequest(HttpContext context)
    {
        return context.Request.Headers.ContainsKey(&quot;HX-Request&quot;);
    }

    private CacheProfile? GetCacheProfile(HttpContext context)
    {
        var path = context.Request.Path.Value?.ToLower() ?? &quot;&quot;;
        var handler = context.Request.Query[&quot;handler&quot;].FirstOrDefault()?.ToLower();

        // Check for specific handler profiles
        if (!string.IsNullOrEmpty(handler))
        {
            var key = $&quot;{path}:{handler}&quot;;
            if (_options.Profiles.TryGetValue(key, out var profile))
            {
                return profile;
            }
        }

        // Check for path-level profiles
        if (_options.Profiles.TryGetValue(path, out var pathProfile))
        {
            return pathProfile;
        }

        return null;
    }

    private void SetCacheHeaders(HttpContext context, CacheProfile profile)
    {
        if (profile.NoStore)
        {
            SetNoCacheHeaders(context);
            return;
        }

        var cacheControl = profile.IsPrivate ? &quot;private&quot; : &quot;public&quot;;
        cacheControl += $&quot;, max-age={profile.MaxAge}&quot;;

        context.Response.Headers[&quot;Cache-Control&quot;] = cacheControl;

        if (profile.VaryByQueryKeys?.Length &gt; 0)
        {
            context.Response.Headers.Append(&quot;Vary&quot;, string.Join(&quot;, &quot;, profile.VaryByQueryKeys));
        }

        _logger.LogDebug(
            &quot;Set cache headers for htmx request: {Path}, Cache-Control: {CacheControl}&quot;,
            context.Request.Path,
            cacheControl);
    }

    private static void SetNoCacheHeaders(HttpContext context)
    {
        context.Response.Headers[&quot;Cache-Control&quot;] = &quot;no-store, no-cache, must-revalidate&quot;;
        context.Response.Headers[&quot;Pragma&quot;] = &quot;no-cache&quot;;
    }
}

public static class HtmxResponseCachingExtensions
{
    public static IServiceCollection AddHtmxResponseCaching(
        this IServiceCollection services,
        Action&lt;HtmxCacheOptions&gt; configure)
    {
        services.Configure(configure);
        return services;
    }

    public static IApplicationBuilder UseHtmxResponseCaching(
        this IApplicationBuilder app)
    {
        return app.UseMiddleware&lt;HtmxResponseCachingMiddleware&gt;();
    }
}</code></pre>
</doc-codeblock></div>
<p><strong>Configuration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// Configure htmx caching profiles
builder.Services.AddHtmxResponseCaching(options =&gt;
{
    options.VaryByHxRequest = true;
    options.DefaultMaxAge = 0;

    // Cache genre list for 1 hour
    options.Profiles[&quot;/artists:genrelist&quot;] = new CacheProfile
    {
        MaxAge = 3600,
        IsPrivate = false
    };

    // Cache navigation for 5 minutes
    options.Profiles[&quot;/shared:navigation&quot;] = new CacheProfile
    {
        MaxAge = 300,
        IsPrivate = false
    };

    // Don't cache search results
    options.Profiles[&quot;/artists:list&quot;] = new CacheProfile
    {
        NoStore = true
    };
});

// In middleware pipeline (after routing, before endpoints)
app.UseHtmxResponseCaching();</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2352-cdn-configuration-for-static-assets">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2352-cdn-configuration-for-static-assets">#</doc-anchor-trigger>
        <span>23.5.2 CDN Configuration for Static Assets</span>
    </h3>
</doc-anchor-target>
<p>Serve static assets from Azure CDN for better global performance.</p>
<doc-anchor-target id="azure-cdn-setup-script">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-cdn-setup-script">#</doc-anchor-trigger>
        <span>Azure CDN Setup Script</span>
    </h4>
</doc-anchor-target>
<p><strong>infrastructure/setup-cdn.sh</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">#!/bin/bash

# Configuration
RESOURCE_GROUP=&quot;chinook-rg&quot;
CDN_PROFILE_NAME=&quot;chinook-cdn&quot;
CDN_ENDPOINT_NAME=&quot;chinook-assets&quot;
WEB_APP_NAME=&quot;chinook-dashboard&quot;
LOCATION=&quot;eastus&quot;

echo &quot;Setting up Azure CDN...&quot;

# Create CDN profile
az cdn profile create \
    --name $CDN_PROFILE_NAME \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --sku Standard_Microsoft \
    --output none

echo &quot;✓ CDN profile created&quot;

# Create CDN endpoint pointing to App Service
az cdn endpoint create \
    --name $CDN_ENDPOINT_NAME \
    --profile-name $CDN_PROFILE_NAME \
    --resource-group $RESOURCE_GROUP \
    --origin &quot;${WEB_APP_NAME}.azurewebsites.net&quot; \
    --origin-host-header &quot;${WEB_APP_NAME}.azurewebsites.net&quot; \
    --enable-compression true \
    --content-types-to-compress \
        &quot;text/html&quot; \
        &quot;text/css&quot; \
        &quot;application/javascript&quot; \
        &quot;text/javascript&quot; \
        &quot;application/json&quot; \
    --output none

echo &quot;✓ CDN endpoint created&quot;

# Add caching rules
az cdn endpoint rule add \
    --name $CDN_ENDPOINT_NAME \
    --profile-name $CDN_PROFILE_NAME \
    --resource-group $RESOURCE_GROUP \
    --order 1 \
    --rule-name &quot;CacheStaticAssets&quot; \
    --match-variable UrlFileExtension \
    --operator Contains \
    --match-values &quot;js&quot; &quot;css&quot; &quot;woff2&quot; &quot;woff&quot; &quot;ttf&quot; \
    --action-name CacheExpiration \
    --cache-behavior Override \
    --cache-duration &quot;365.00:00:00&quot; \
    --output none

echo &quot;✓ Caching rule added for static assets&quot;

# Add rule to bypass cache for htmx requests
az cdn endpoint rule add \
    --name $CDN_ENDPOINT_NAME \
    --profile-name $CDN_PROFILE_NAME \
    --resource-group $RESOURCE_GROUP \
    --order 2 \
    --rule-name &quot;BypassHtmxRequests&quot; \
    --match-variable RequestHeader \
    --selector &quot;HX-Request&quot; \
    --operator Any \
    --action-name CacheExpiration \
    --cache-behavior BypassCache \
    --output none

echo &quot;✓ Bypass rule added for htmx requests&quot;

# Output CDN URL
CDN_URL=&quot;https://${CDN_ENDPOINT_NAME}.azureedge.net&quot;
echo &quot;&quot;
echo &quot;CDN setup complete!&quot;
echo &quot;CDN URL: $CDN_URL&quot;
echo &quot;&quot;
echo &quot;Update your application to use CDN for static assets:&quot;
echo &quot;  &lt;script src=\&quot;$CDN_URL/lib/htmx/htmx.min.js\&quot;&gt;&lt;/script&gt;&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="cache-invalidation">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cache-invalidation">#</doc-anchor-trigger>
        <span>Cache Invalidation</span>
    </h4>
</doc-anchor-target>
<p>Purge CDN cache after deployments:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Purge specific paths
az cdn endpoint purge \
    --name chinook-assets \
    --profile-name chinook-cdn \
    --resource-group chinook-rg \
    --content-paths &quot;/css/*&quot; &quot;/js/*&quot; &quot;/lib/*&quot;

# Or purge everything
az cdn endpoint purge \
    --name chinook-assets \
    --profile-name chinook-cdn \
    --resource-group chinook-rg \
    --content-paths &quot;/*&quot;</code></pre>
</doc-codeblock></div>
<p>Add to deployment workflow:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">      - name: Purge CDN cache
        run: |
          az cdn endpoint purge \
            --name chinook-assets \
            --profile-name chinook-cdn \
            --resource-group ${{ ERROR }} \
            --content-paths &quot;/css/*&quot; &quot;/js/*&quot; &quot;/lib/*&quot; \
            --no-wait</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2353-health-checks-and-monitoring">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2353-health-checks-and-monitoring">#</doc-anchor-trigger>
        <span>23.5.3 Health Checks and Monitoring</span>
    </h3>
</doc-anchor-target>
<p>Health checks enable Azure to detect unhealthy instances and route traffic appropriately.</p>
<doc-anchor-target id="databasehealthcheck-implementation">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#databasehealthcheck-implementation">#</doc-anchor-trigger>
        <span>DatabaseHealthCheck Implementation</span>
    </h4>
</doc-anchor-target>
<p><strong>Health/DatabaseHealthCheck.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using Microsoft.Extensions.Diagnostics.HealthChecks;
using Microsoft.EntityFrameworkCore;
using ChinookDashboard.Data;

namespace ChinookDashboard.Health;

public class DatabaseHealthCheck : IHealthCheck
{
    private readonly ChinookContext _context;
    private readonly ILogger&lt;DatabaseHealthCheck&gt; _logger;

    public DatabaseHealthCheck(
        ChinookContext context,
        ILogger&lt;DatabaseHealthCheck&gt; logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task&lt;HealthCheckResult&gt; CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        try
        {
            // Simple connectivity check
            var canConnect = await _context.Database.CanConnectAsync(cancellationToken);

            if (!canConnect)
            {
                _logger.LogWarning(&quot;Database health check failed: Cannot connect&quot;);
                return HealthCheckResult.Unhealthy(&quot;Cannot connect to database&quot;);
            }

            // Query check - verify we can read data
            var artistCount = await _context.Artists
                .CountAsync(cancellationToken);

            var data = new Dictionary&lt;string, object&gt;
            {
                { &quot;artistCount&quot;, artistCount },
                { &quot;timestamp&quot;, DateTime.UtcNow }
            };

            _logger.LogDebug(&quot;Database health check passed: {ArtistCount} artists&quot;, artistCount);

            return HealthCheckResult.Healthy(&quot;Database is responsive&quot;, data);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, &quot;Database health check exception&quot;);

            return HealthCheckResult.Unhealthy(
                &quot;Database check failed&quot;,
                exception: ex);
        }
    }
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="complete-health-check-registration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#complete-health-check-registration">#</doc-anchor-trigger>
        <span>Complete Health Check Registration</span>
    </h4>
</doc-anchor-target>
<p><strong>Health/HealthCheckExtensions.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using Microsoft.AspNetCore.Diagnostics.HealthChecks;
using Microsoft.Extensions.Diagnostics.HealthChecks;
using System.Text.Json;

namespace ChinookDashboard.Health;

public static class HealthCheckExtensions
{
    public static IServiceCollection AddChinookHealthChecks(
        this IServiceCollection services)
    {
        services.AddHealthChecks()
            .AddCheck&lt;DatabaseHealthCheck&gt;(
                &quot;database&quot;,
                failureStatus: HealthStatus.Unhealthy,
                tags: new[] { &quot;db&quot;, &quot;sql&quot; })
            .AddCheck(&quot;self&quot;, () =&gt; HealthCheckResult.Healthy(&quot;Application is running&quot;),
                tags: new[] { &quot;self&quot; });

        return services;
    }

    public static IApplicationBuilder UseChinookHealthChecks(
        this IApplicationBuilder app)
    {
        // Simple health endpoint for load balancers
        app.UseHealthChecks(&quot;/health&quot;, new HealthCheckOptions
        {
            Predicate = check =&gt; check.Tags.Contains(&quot;self&quot;),
            ResponseWriter = WriteMinimalResponse
        });

        // Detailed health endpoint for monitoring
        app.UseHealthChecks(&quot;/health/detail&quot;, new HealthCheckOptions
        {
            ResponseWriter = WriteDetailedResponse
        });

        // htmx-compatible health endpoint
        app.UseHealthChecks(&quot;/health/htmx&quot;, new HealthCheckOptions
        {
            ResponseWriter = WriteHtmxResponse
        });

        return app;
    }

    private static Task WriteMinimalResponse(
        HttpContext context,
        HealthReport report)
    {
        context.Response.ContentType = &quot;text/plain&quot;;
        return context.Response.WriteAsync(report.Status.ToString());
    }

    private static async Task WriteDetailedResponse(
        HttpContext context,
        HealthReport report)
    {
        context.Response.ContentType = &quot;application/json&quot;;

        var response = new
        {
            status = report.Status.ToString(),
            duration = report.TotalDuration.TotalMilliseconds,
            timestamp = DateTime.UtcNow,
            checks = report.Entries.Select(e =&gt; new
            {
                name = e.Key,
                status = e.Value.Status.ToString(),
                duration = e.Value.Duration.TotalMilliseconds,
                description = e.Value.Description,
                data = e.Value.Data,
                exception = e.Value.Exception?.Message
            })
        };

        await context.Response.WriteAsync(
            JsonSerializer.Serialize(response, new JsonSerializerOptions
            {
                WriteIndented = true
            }));
    }

    private static async Task WriteHtmxResponse(
        HttpContext context,
        HealthReport report)
    {
        context.Response.ContentType = &quot;text/html&quot;;

        var statusClass = report.Status switch
        {
            HealthStatus.Healthy =&gt; &quot;text-green-600&quot;,
            HealthStatus.Degraded =&gt; &quot;text-yellow-600&quot;,
            _ =&gt; &quot;text-red-600&quot;
        };

        var html = $@&quot;
&lt;div id=&quot;&quot;health-status&quot;&quot; class=&quot;&quot;p-4 rounded border&quot;&quot;&gt;
    &lt;div class=&quot;&quot;flex items-center gap-2 mb-2&quot;&quot;&gt;
        &lt;span class=&quot;&quot;font-bold {statusClass}&quot;&quot;&gt;{report.Status}&lt;/span&gt;
        &lt;span class=&quot;&quot;text-gray-500 text-sm&quot;&quot;&gt;({report.TotalDuration.TotalMilliseconds:F0}ms)&lt;/span&gt;
    &lt;/div&gt;
    &lt;ul class=&quot;&quot;text-sm space-y-1&quot;&quot;&gt;
        {string.Join(&quot;\n&quot;, report.Entries.Select(e =&gt; $@&quot;
        &lt;li class=&quot;&quot;flex justify-between&quot;&quot;&gt;
            &lt;span&gt;{e.Key}&lt;/span&gt;
            &lt;span class=&quot;&quot;{GetStatusClass(e.Value.Status)}&quot;&quot;&gt;{e.Value.Status}&lt;/span&gt;
        &lt;/li&gt;&quot;))}
    &lt;/ul&gt;
    &lt;div class=&quot;&quot;text-xs text-gray-400 mt-2&quot;&quot;&gt;
        Last checked: {DateTime.UtcNow:HH:mm:ss} UTC
    &lt;/div&gt;
&lt;/div&gt;&quot;;

        await context.Response.WriteAsync(html);
    }

    private static string GetStatusClass(HealthStatus status) =&gt; status switch
    {
        HealthStatus.Healthy =&gt; &quot;text-green-600&quot;,
        HealthStatus.Degraded =&gt; &quot;text-yellow-600&quot;,
        _ =&gt; &quot;text-red-600&quot;
    };
}</code></pre>
</doc-codeblock></div>
<p><strong>Registration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// Services
builder.Services.AddChinookHealthChecks();

// Middleware (after routing)
app.UseChinookHealthChecks();</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2354-error-handling-in-production">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2354-error-handling-in-production">#</doc-anchor-trigger>
        <span>23.5.4 Error Handling in Production</span>
    </h3>
</doc-anchor-target>
<p>Production error handling should return appropriate responses for htmx requests versus full page requests.</p>
<doc-anchor-target id="productionexceptionmiddleware">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#productionexceptionmiddleware">#</doc-anchor-trigger>
        <span>ProductionExceptionMiddleware</span>
    </h4>
</doc-anchor-target>
<p><strong>Middleware/ProductionExceptionMiddleware.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using System.Net;

namespace ChinookDashboard.Middleware;

public class ProductionExceptionMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger&lt;ProductionExceptionMiddleware&gt; _logger;
    private readonly IWebHostEnvironment _environment;

    public ProductionExceptionMiddleware(
        RequestDelegate next,
        ILogger&lt;ProductionExceptionMiddleware&gt; logger,
        IWebHostEnvironment environment)
    {
        _next = next;
        _logger = logger;
        _environment = environment;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);

            // Handle status code errors (404, etc.)
            if (context.Response.StatusCode &gt;= 400 &amp;&amp; !context.Response.HasStarted)
            {
                await HandleStatusCodeAsync(context);
            }
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }

    private async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        var requestId = context.TraceIdentifier;
        var isHtmxRequest = context.Request.Headers.ContainsKey(&quot;HX-Request&quot;);

        _logger.LogError(
            exception,
            &quot;Unhandled exception. RequestId: {RequestId}, Path: {Path}, IsHtmx: {IsHtmx}&quot;,
            requestId,
            context.Request.Path,
            isHtmxRequest);

        context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;

        if (isHtmxRequest)
        {
            await WriteHtmxErrorAsync(context, 500, requestId);
        }
        else
        {
            await WriteFullPageErrorAsync(context, 500, requestId);
        }
    }

    private async Task HandleStatusCodeAsync(HttpContext context)
    {
        var isHtmxRequest = context.Request.Headers.ContainsKey(&quot;HX-Request&quot;);
        var statusCode = context.Response.StatusCode;
        var requestId = context.TraceIdentifier;

        if (isHtmxRequest)
        {
            await WriteHtmxErrorAsync(context, statusCode, requestId);
        }
        else if (statusCode == 404)
        {
            await WriteFullPageErrorAsync(context, 404, requestId);
        }
    }

    private async Task WriteHtmxErrorAsync(
        HttpContext context,
        int statusCode,
        string requestId)
    {
        context.Response.ContentType = &quot;text/html; charset=utf-8&quot;;

        // Set htmx headers to show error in appropriate location
        context.Response.Headers[&quot;HX-Retarget&quot;] = &quot;#error-container&quot;;
        context.Response.Headers[&quot;HX-Reswap&quot;] = &quot;innerHTML&quot;;

        var (title, message) = GetErrorContent(statusCode);
        var showDetails = _environment.IsDevelopment();

        var html = $@&quot;
&lt;div class=&quot;&quot;bg-red-50 border border-red-200 rounded-lg p-4 my-4&quot;&quot; role=&quot;&quot;alert&quot;&quot;&gt;
    &lt;div class=&quot;&quot;flex items-start gap-3&quot;&quot;&gt;
        &lt;svg class=&quot;&quot;w-5 h-5 text-red-600 mt-0.5&quot;&quot; fill=&quot;&quot;currentColor&quot;&quot; viewBox=&quot;&quot;0 0 20 20&quot;&quot;&gt;
            &lt;path fill-rule=&quot;&quot;evenodd&quot;&quot; d=&quot;&quot;M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z&quot;&quot; clip-rule=&quot;&quot;evenodd&quot;&quot;/&gt;
        &lt;/svg&gt;
        &lt;div class=&quot;&quot;flex-1&quot;&quot;&gt;
            &lt;h3 class=&quot;&quot;font-medium text-red-800&quot;&quot;&gt;{title}&lt;/h3&gt;
            &lt;p class=&quot;&quot;text-sm text-red-700 mt-1&quot;&quot;&gt;{message}&lt;/p&gt;
            {(showDetails ? $&quot;&lt;p class=\&quot;text-xs text-red-500 mt-2\&quot;&gt;Request ID: {requestId}&lt;/p&gt;&quot; : &quot;&quot;)}
        &lt;/div&gt;
        &lt;button type=&quot;&quot;button&quot;&quot; 
                class=&quot;&quot;text-red-500 hover:text-red-700&quot;&quot; 
                onclick=&quot;&quot;this.closest('[role=alert]').remove()&quot;&quot;&gt;
            &lt;svg class=&quot;&quot;w-4 h-4&quot;&quot; fill=&quot;&quot;currentColor&quot;&quot; viewBox=&quot;&quot;0 0 20 20&quot;&quot;&gt;
                &lt;path fill-rule=&quot;&quot;evenodd&quot;&quot; d=&quot;&quot;M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z&quot;&quot; clip-rule=&quot;&quot;evenodd&quot;&quot;/&gt;
            &lt;/svg&gt;
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;&quot;;

        await context.Response.WriteAsync(html);
    }

    private async Task WriteFullPageErrorAsync(
        HttpContext context,
        int statusCode,
        string requestId)
    {
        context.Response.ContentType = &quot;text/html; charset=utf-8&quot;;

        var (title, message) = GetErrorContent(statusCode);
        var showDetails = _environment.IsDevelopment();

        var html = $@&quot;
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;&quot;en&quot;&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;&quot;utf-8&quot;&quot; /&gt;
    &lt;meta name=&quot;&quot;viewport&quot;&quot; content=&quot;&quot;width=device-width, initial-scale=1.0&quot;&quot; /&gt;
    &lt;title&gt;{title} - Chinook Dashboard&lt;/title&gt;
    &lt;link rel=&quot;&quot;stylesheet&quot;&quot; href=&quot;&quot;/css/site.min.css&quot;&quot; /&gt;
&lt;/head&gt;
&lt;body class=&quot;&quot;bg-gray-50 min-h-screen flex items-center justify-center&quot;&quot;&gt;
    &lt;div class=&quot;&quot;max-w-md mx-auto text-center p-8&quot;&quot;&gt;
        &lt;div class=&quot;&quot;text-6xl font-bold text-gray-300 mb-4&quot;&quot;&gt;{statusCode}&lt;/div&gt;
        &lt;h1 class=&quot;&quot;text-2xl font-bold text-gray-800 mb-2&quot;&quot;&gt;{title}&lt;/h1&gt;
        &lt;p class=&quot;&quot;text-gray-600 mb-6&quot;&quot;&gt;{message}&lt;/p&gt;
        &lt;a href=&quot;&quot;/&quot;&quot; class=&quot;&quot;inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700&quot;&quot;&gt;
            &lt;svg class=&quot;&quot;w-4 h-4&quot;&quot; fill=&quot;&quot;none&quot;&quot; stroke=&quot;&quot;currentColor&quot;&quot; viewBox=&quot;&quot;0 0 24 24&quot;&quot;&gt;
                &lt;path stroke-linecap=&quot;&quot;round&quot;&quot; stroke-linejoin=&quot;&quot;round&quot;&quot; stroke-width=&quot;&quot;2&quot;&quot; d=&quot;&quot;M10 19l-7-7m0 0l7-7m-7 7h18&quot;&quot;/&gt;
            &lt;/svg&gt;
            Back to Home
        &lt;/a&gt;
        {(showDetails ? $&quot;&lt;p class=\&quot;text-xs text-gray-400 mt-8\&quot;&gt;Request ID: {requestId}&lt;/p&gt;&quot; : &quot;&quot;)}
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;&quot;;

        await context.Response.WriteAsync(html);
    }

    private static (string Title, string Message) GetErrorContent(int statusCode)
    {
        return statusCode switch
        {
            400 =&gt; (&quot;Bad Request&quot;, &quot;The request could not be understood. Please check your input and try again.&quot;),
            401 =&gt; (&quot;Unauthorized&quot;, &quot;You need to sign in to access this resource.&quot;),
            403 =&gt; (&quot;Forbidden&quot;, &quot;You don't have permission to access this resource.&quot;),
            404 =&gt; (&quot;Not Found&quot;, &quot;The page you're looking for doesn't exist or has been moved.&quot;),
            408 =&gt; (&quot;Request Timeout&quot;, &quot;The request took too long to complete. Please try again.&quot;),
            500 =&gt; (&quot;Server Error&quot;, &quot;Something went wrong on our end. We've been notified and are working on it.&quot;),
            502 =&gt; (&quot;Bad Gateway&quot;, &quot;The server received an invalid response. Please try again later.&quot;),
            503 =&gt; (&quot;Service Unavailable&quot;, &quot;The service is temporarily unavailable. Please try again later.&quot;),
            _ =&gt; (&quot;Error&quot;, &quot;An unexpected error occurred. Please try again.&quot;)
        };
    }
}

public static class ProductionExceptionMiddlewareExtensions
{
    public static IApplicationBuilder UseProductionExceptionHandler(
        this IApplicationBuilder app)
    {
        return app.UseMiddleware&lt;ProductionExceptionMiddleware&gt;();
    }
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="error-partial-views">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#error-partial-views">#</doc-anchor-trigger>
        <span>Error Partial Views</span>
    </h4>
</doc-anchor-target>
<p>For more complex error templates, use Razor partial views:</p>
<p><strong>Pages/Shared/_Error404.cshtml</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">@{
    Layout = null;
}
&lt;div class=&quot;bg-yellow-50 border border-yellow-200 rounded-lg p-4&quot; role=&quot;alert&quot;&gt;
    &lt;div class=&quot;flex items-center gap-3&quot;&gt;
        &lt;svg class=&quot;w-5 h-5 text-yellow-600&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;
            &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z&quot; clip-rule=&quot;evenodd&quot;/&gt;
        &lt;/svg&gt;
        &lt;div&gt;
            &lt;h3 class=&quot;font-medium text-yellow-800&quot;&gt;Not Found&lt;/h3&gt;
            &lt;p class=&quot;text-sm text-yellow-700&quot;&gt;The requested resource could not be found.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</doc-codeblock></div>
<p><strong>Pages/Shared/_Error500.cshtml</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">@{
    Layout = null;
}
&lt;div class=&quot;bg-red-50 border border-red-200 rounded-lg p-4&quot; role=&quot;alert&quot;&gt;
    &lt;div class=&quot;flex items-center gap-3&quot;&gt;
        &lt;svg class=&quot;w-5 h-5 text-red-600&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;
            &lt;path fill-rule=&quot;evenodd&quot; d=&quot;M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z&quot; clip-rule=&quot;evenodd&quot;/&gt;
        &lt;/svg&gt;
        &lt;div&gt;
            &lt;h3 class=&quot;font-medium text-red-800&quot;&gt;Server Error&lt;/h3&gt;
            &lt;p class=&quot;text-sm text-red-700&quot;&gt;Something went wrong. Please try again later.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</doc-codeblock></div>
<p><strong>Registration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// Use production exception handler early in pipeline
if (!app.Environment.IsDevelopment())
{
    app.UseProductionExceptionHandler();
}
else
{
    app.UseDeveloperExceptionPage();
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="error-container-in-layout">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#error-container-in-layout">#</doc-anchor-trigger>
        <span>Error Container in Layout</span>
    </h4>
</doc-anchor-target>
<p>Add an error container to your layout for htmx error responses:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">&lt;!-- In _Layout.cshtml, before main content --&gt;
&lt;div id=&quot;error-container&quot; class=&quot;container mx-auto px-4&quot;&gt;
    &lt;!-- htmx errors will be swapped here --&gt;
&lt;/div&gt;

&lt;main class=&quot;container mx-auto px-4 py-8&quot;&gt;
    @RenderBody()
&lt;/main&gt;</code></pre>
</doc-codeblock></div>
<p>This ensures htmx error responses have a consistent location to display, while maintaining the ability to show inline errors when appropriate.</p>
<doc-anchor-target id="236-monitoring-and-troubleshooting">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#236-monitoring-and-troubleshooting">#</doc-anchor-trigger>
        <span>23.6 Monitoring and Troubleshooting</span>
    </h2>
</doc-anchor-target>
<p>Production applications need visibility into performance, errors, and usage patterns. Azure Application Insights provides deep monitoring for ASP.NET Core applications.</p>
<doc-anchor-target id="2361-application-insights-setup">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2361-application-insights-setup">#</doc-anchor-trigger>
        <span>23.6.1 Application Insights Setup</span>
    </h3>
</doc-anchor-target>
<p>Install the Application Insights package:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">dotnet add package Microsoft.ApplicationInsights.AspNetCore</code></pre>
</doc-codeblock></div>
<p><strong>Basic Configuration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// Add Application Insights
builder.Services.AddApplicationInsightsTelemetry(options =&gt;
{
    options.ConnectionString = builder.Configuration[&quot;ApplicationInsights:ConnectionString&quot;];
    options.EnableAdaptiveSampling = true;
    options.EnableQuickPulseMetricStream = true; // Live metrics
});</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="htmxtelemetrymiddleware">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#htmxtelemetrymiddleware">#</doc-anchor-trigger>
        <span>HtmxTelemetryMiddleware</span>
    </h4>
</doc-anchor-target>
<p>Track htmx-specific properties for better insights into partial request patterns.</p>
<p><strong>Middleware/HtmxTelemetryMiddleware.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using Microsoft.ApplicationInsights;
using Microsoft.ApplicationInsights.DataContracts;
using System.Diagnostics;

namespace ChinookDashboard.Middleware;

public class HtmxTelemetryMiddleware
{
    private readonly RequestDelegate _next;
    private readonly TelemetryClient _telemetryClient;
    private readonly ILogger&lt;HtmxTelemetryMiddleware&gt; _logger;

    public HtmxTelemetryMiddleware(
        RequestDelegate next,
        TelemetryClient telemetryClient,
        ILogger&lt;HtmxTelemetryMiddleware&gt; logger)
    {
        _next = next;
        _telemetryClient = telemetryClient;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var isHtmxRequest = context.Request.Headers.ContainsKey(&quot;HX-Request&quot;);
        var stopwatch = Stopwatch.StartNew();

        // Extract htmx headers
        var htmxTarget = context.Request.Headers[&quot;HX-Target&quot;].FirstOrDefault();
        var htmxTrigger = context.Request.Headers[&quot;HX-Trigger&quot;].FirstOrDefault();
        var htmxTriggerName = context.Request.Headers[&quot;HX-Trigger-Name&quot;].FirstOrDefault();
        var htmxCurrentUrl = context.Request.Headers[&quot;HX-Current-URL&quot;].FirstOrDefault();
        var handler = context.Request.Query[&quot;handler&quot;].FirstOrDefault();

        // Add properties to the current request telemetry
        var requestTelemetry = context.Features.Get&lt;RequestTelemetry&gt;();
        if (requestTelemetry != null)
        {
            requestTelemetry.Properties[&quot;IsHtmxRequest&quot;] = isHtmxRequest.ToString();
            requestTelemetry.Properties[&quot;RequestType&quot;] = isHtmxRequest ? &quot;htmx-partial&quot; : &quot;full-page&quot;;

            if (!string.IsNullOrEmpty(htmxTarget))
                requestTelemetry.Properties[&quot;HX-Target&quot;] = htmxTarget;

            if (!string.IsNullOrEmpty(htmxTrigger))
                requestTelemetry.Properties[&quot;HX-Trigger&quot;] = htmxTrigger;

            if (!string.IsNullOrEmpty(htmxTriggerName))
                requestTelemetry.Properties[&quot;HX-Trigger-Name&quot;] = htmxTriggerName;

            if (!string.IsNullOrEmpty(handler))
                requestTelemetry.Properties[&quot;Handler&quot;] = handler;
        }

        try
        {
            await _next(context);
        }
        finally
        {
            stopwatch.Stop();

            // Track custom metrics for htmx requests
            if (isHtmxRequest)
            {
                var metricName = $&quot;HtmxResponse/{handler ?? &quot;default&quot;}&quot;;
                
                _telemetryClient.TrackMetric(new MetricTelemetry
                {
                    Name = &quot;HtmxResponseTime&quot;,
                    Sum = stopwatch.ElapsedMilliseconds,
                    Count = 1,
                    Properties =
                    {
                        [&quot;Handler&quot;] = handler ?? &quot;none&quot;,
                        [&quot;Target&quot;] = htmxTarget ?? &quot;none&quot;,
                        [&quot;StatusCode&quot;] = context.Response.StatusCode.ToString()
                    }
                });

                // Track response size for htmx responses
                if (context.Response.ContentLength.HasValue)
                {
                    _telemetryClient.TrackMetric(new MetricTelemetry
                    {
                        Name = &quot;HtmxResponseSize&quot;,
                        Sum = context.Response.ContentLength.Value,
                        Count = 1,
                        Properties =
                        {
                            [&quot;Handler&quot;] = handler ?? &quot;none&quot;
                        }
                    });
                }
            }

            // Log slow requests
            if (stopwatch.ElapsedMilliseconds &gt; 1000)
            {
                _logger.LogWarning(
                    &quot;Slow request: {Path} took {Duration}ms (htmx: {IsHtmx}, handler: {Handler})&quot;,
                    context.Request.Path,
                    stopwatch.ElapsedMilliseconds,
                    isHtmxRequest,
                    handler);
            }
        }
    }
}

public static class HtmxTelemetryMiddlewareExtensions
{
    public static IApplicationBuilder UseHtmxTelemetry(this IApplicationBuilder app)
    {
        return app.UseMiddleware&lt;HtmxTelemetryMiddleware&gt;();
    }
}</code></pre>
</doc-codeblock></div>
<p><strong>Registration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// After UseRouting, before UseEndpoints
app.UseHtmxTelemetry();</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2362-logging-best-practices">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2362-logging-best-practices">#</doc-anchor-trigger>
        <span>23.6.2 Logging Best Practices</span>
    </h3>
</doc-anchor-target>
<p>Serilog provides structured logging with multiple sinks for different environments.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.ApplicationInsights
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.File
dotnet add package Serilog.Expressions</code></pre>
</doc-codeblock></div>
<p><strong>Complete Serilog Configuration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">using Serilog;
using Serilog.Events;

// Configure Serilog early
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Warning)
    .MinimumLevel.Override(&quot;Microsoft.AspNetCore&quot;, LogEventLevel.Warning)
    .MinimumLevel.Override(&quot;Microsoft.EntityFrameworkCore&quot;, LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .Enrich.WithMachineName()
    .Enrich.WithEnvironmentName()
    .WriteTo.Console(
        outputTemplate: &quot;[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}&quot;)
    .CreateBootstrapLogger();

try
{
    var builder = WebApplication.CreateBuilder(args);

    // Configure Serilog from appsettings
    builder.Host.UseSerilog((context, services, configuration) =&gt; configuration
        .ReadFrom.Configuration(context.Configuration)
        .ReadFrom.Services(services)
        .Enrich.FromLogContext()
        .Enrich.WithMachineName()
        .Enrich.WithProperty(&quot;Application&quot;, &quot;ChinookDashboard&quot;));

    // ... rest of configuration

    var app = builder.Build();

    // Add request logging
    app.UseSerilogRequestLogging(options =&gt;
    {
        options.EnrichDiagnosticContext = (diagnosticContext, httpContext) =&gt;
        {
            diagnosticContext.Set(&quot;RequestHost&quot;, httpContext.Request.Host.Value);
            diagnosticContext.Set(&quot;IsHtmxRequest&quot;, httpContext.Request.Headers.ContainsKey(&quot;HX-Request&quot;));
            
            var handler = httpContext.Request.Query[&quot;handler&quot;].FirstOrDefault();
            if (!string.IsNullOrEmpty(handler))
                diagnosticContext.Set(&quot;Handler&quot;, handler);
        };
        
        // Don't log health checks
        options.GetLevel = (httpContext, elapsed, ex) =&gt;
        {
            if (httpContext.Request.Path.StartsWithSegments(&quot;/health&quot;))
                return LogEventLevel.Verbose;
            
            return elapsed &gt; 1000 ? LogEventLevel.Warning : LogEventLevel.Information;
        };
    });

    // ... rest of app configuration

    app.Run();
}
catch (Exception ex)
{
    Log.Fatal(ex, &quot;Application terminated unexpectedly&quot;);
}
finally
{
    Log.CloseAndFlush();
}</code></pre>
</doc-codeblock></div>
<p><strong>appsettings.Production.json Serilog Section:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
  &quot;Serilog&quot;: {
    &quot;Using&quot;: [
      &quot;Serilog.Sinks.Console&quot;,
      &quot;Serilog.Sinks.ApplicationInsights&quot;,
      &quot;Serilog.Sinks.File&quot;
    ],
    &quot;MinimumLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Override&quot;: {
        &quot;Microsoft&quot;: &quot;Warning&quot;,
        &quot;Microsoft.AspNetCore&quot;: &quot;Warning&quot;,
        &quot;Microsoft.EntityFrameworkCore&quot;: &quot;Warning&quot;,
        &quot;System&quot;: &quot;Warning&quot;
      }
    },
    &quot;WriteTo&quot;: [
      {
        &quot;Name&quot;: &quot;Console&quot;,
        &quot;Args&quot;: {
          &quot;outputTemplate&quot;: &quot;[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}&quot;
        }
      },
      {
        &quot;Name&quot;: &quot;ApplicationInsights&quot;,
        &quot;Args&quot;: {
          &quot;connectionString&quot;: &quot;SET_IN_AZURE&quot;,
          &quot;telemetryConverter&quot;: &quot;Serilog.Sinks.ApplicationInsights.TelemetryConverters.TraceTelemetryConverter, Serilog.Sinks.ApplicationInsights&quot;
        }
      },
      {
        &quot;Name&quot;: &quot;File&quot;,
        &quot;Args&quot;: {
          &quot;path&quot;: &quot;/home/LogFiles/Application/chinook-.log&quot;,
          &quot;rollingInterval&quot;: &quot;Day&quot;,
          &quot;retainedFileCountLimit&quot;: 7,
          &quot;outputTemplate&quot;: &quot;{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj}{NewLine}{Exception}&quot;
        }
      }
    ],
    &quot;Filter&quot;: [
      {
        &quot;Name&quot;: &quot;ByExcluding&quot;,
        &quot;Args&quot;: {
          &quot;expression&quot;: &quot;RequestPath like '/health%'&quot;
        }
      },
      {
        &quot;Name&quot;: &quot;ByExcluding&quot;,
        &quot;Args&quot;: {
          &quot;expression&quot;: &quot;@m like '%password%' or @m like '%token%' or @m like '%secret%'&quot;
        }
      }
    ],
    &quot;Enrich&quot;: [
      &quot;FromLogContext&quot;,
      &quot;WithMachineName&quot;,
      &quot;WithEnvironmentName&quot;
    ]
  }
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2363-performance-monitoring">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2363-performance-monitoring">#</doc-anchor-trigger>
        <span>23.6.3 Performance Monitoring</span>
    </h3>
</doc-anchor-target>
<doc-anchor-target id="key-metrics-for-htmx-applications">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#key-metrics-for-htmx-applications">#</doc-anchor-trigger>
        <span>Key Metrics for htmx Applications</span>
    </h4>
</doc-anchor-target>
<p>Track these metrics in Application Insights:</p>
<ul>
<li><strong>Response Time</strong>: Average and P95 for htmx vs full page requests</li>
<li><strong>Throughput</strong>: Requests per second by handler</li>
<li><strong>Error Rate</strong>: Failed requests percentage</li>
<li><strong>Response Size</strong>: Average partial response size</li>
</ul>
<doc-anchor-target id="custom-application-insights-queries">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#custom-application-insights-queries">#</doc-anchor-trigger>
        <span>Custom Application Insights Queries</span>
    </h4>
</doc-anchor-target>
<p>Query htmx-specific performance data in Log Analytics:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-kusto"><code v-pre class="language-kusto">// Average response time by handler for htmx requests
requests
| where customDimensions.IsHtmxRequest == &quot;True&quot;
| summarize 
    AvgDuration = avg(duration),
    P95Duration = percentile(duration, 95),
    RequestCount = count()
    by Handler = tostring(customDimensions.Handler)
| order by RequestCount desc

// Slow htmx requests (&gt; 500ms)
requests
| where customDimensions.IsHtmxRequest == &quot;True&quot;
| where duration &gt; 500
| project 
    timestamp,
    name,
    duration,
    Handler = customDimensions.Handler,
    Target = customDimensions[&quot;HX-Target&quot;],
    resultCode
| order by duration desc

// htmx vs full page request comparison
requests
| summarize 
    AvgDuration = avg(duration),
    Count = count()
    by RequestType = tostring(customDimensions.RequestType)

// Error rate by handler
requests
| where customDimensions.IsHtmxRequest == &quot;True&quot;
| summarize 
    TotalRequests = count(),
    FailedRequests = countif(toint(resultCode) &gt;= 400)
    by Handler = tostring(customDimensions.Handler)
| extend ErrorRate = (FailedRequests * 100.0) / TotalRequests
| order by ErrorRate desc</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="azure-monitor-alerts">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-monitor-alerts">#</doc-anchor-trigger>
        <span>Azure Monitor Alerts</span>
    </h4>
</doc-anchor-target>
<p>Create alerts for critical conditions:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Alert for high error rate
az monitor metrics alert create \
    --name &quot;HighErrorRate&quot; \
    --resource-group chinook-rg \
    --scopes &quot;/subscriptions/{sub}/resourceGroups/chinook-rg/providers/Microsoft.Web/sites/chinook-dashboard&quot; \
    --condition &quot;avg requests/failed &gt; 10&quot; \
    --window-size 5m \
    --evaluation-frequency 1m \
    --action-group chinook-alerts \
    --description &quot;High error rate detected&quot;

# Alert for slow response times
az monitor metrics alert create \
    --name &quot;SlowResponses&quot; \
    --resource-group chinook-rg \
    --scopes &quot;/subscriptions/{sub}/resourceGroups/chinook-rg/providers/Microsoft.Web/sites/chinook-dashboard&quot; \
    --condition &quot;avg HttpResponseTime &gt; 2000&quot; \
    --window-size 5m \
    --evaluation-frequency 1m \
    --action-group chinook-alerts \
    --description &quot;Response times exceeding 2 seconds&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2364-debugging-production-issues">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2364-debugging-production-issues">#</doc-anchor-trigger>
        <span>23.6.4 Debugging Production Issues</span>
    </h3>
</doc-anchor-target>
<doc-anchor-target id="azure-kudu-console">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-kudu-console">#</doc-anchor-trigger>
        <span>Azure Kudu Console</span>
    </h4>
</doc-anchor-target>
<p>Access the Kudu console at <code v-pre>https://{app-name}.scm.azurewebsites.net</code>:</p>
<ul>
<li><strong>Debug Console</strong>: Browse files, run commands</li>
<li><strong>Process Explorer</strong>: View running processes</li>
<li><strong>Log Stream</strong>: Real-time log viewing</li>
<li><strong>Environment</strong>: Check environment variables</li>
</ul>
<doc-anchor-target id="log-streaming-via-cli">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#log-streaming-via-cli">#</doc-anchor-trigger>
        <span>Log Streaming via CLI</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Stream logs in real-time
az webapp log tail \
    --name chinook-dashboard \
    --resource-group chinook-rg

# Download logs
az webapp log download \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --log-file logs.zip</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="common-htmx-deployment-issues">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#common-htmx-deployment-issues">#</doc-anchor-trigger>
        <span>Common htmx Deployment Issues</span>
    </h4>
</doc-anchor-target>
<p><strong>Anti-forgery Token Failures:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">System.InvalidOperationException: The antiforgery token could not be decrypted.</code></pre>
</doc-codeblock></div>
<p>Solution: Configure data protection key storage (see Section 23.8.2).</p>
<p><strong>Missing Partial Views (Linux case sensitivity):</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">InvalidOperationException: The view 'Artists/_ArtistRow' was not found.</code></pre>
</doc-codeblock></div>
<p>Solution: Ensure file names match exactly, including case. <code v-pre>_artistRow.cshtml</code> won&#x27;t be found if code references <code v-pre>_ArtistRow</code>.</p>
<p><strong>CORS Issues with CDN:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Access to fetch at 'https://cdn...' from origin 'https://app...' has been blocked by CORS policy</code></pre>
</doc-codeblock></div>
<p>Solution: Configure CORS headers on CDN or serve htmx responses from the origin.</p>
<doc-anchor-target id="troubleshooting-checklist">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#troubleshooting-checklist">#</doc-anchor-trigger>
        <span>Troubleshooting Checklist</span>
    </h4>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Issue</th>
<th>Check</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>500 errors</td>
<td>Application Insights exceptions</td>
<td>Review stack trace, fix code</td>
</tr>
<tr>
<td>Anti-forgery failures</td>
<td>Data protection key storage</td>
<td>Configure Azure Blob Storage for keys</td>
</tr>
<tr>
<td>Slow responses</td>
<td>Application Insights dependencies</td>
<td>Optimize database queries</td>
</tr>
<tr>
<td>Missing views</td>
<td>File names, case sensitivity</td>
<td>Match exact casing on Linux</td>
</tr>
<tr>
<td>htmx not working</td>
<td>Browser console, network tab</td>
<td>Check for JavaScript errors</td>
</tr>
<tr>
<td>SSL errors</td>
<td>Certificate binding</td>
<td>Verify SSL certificate status</td>
</tr>
</tbody>
</table>
</div>
<hr>
<doc-anchor-target id="237-scaling-and-performance">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#237-scaling-and-performance">#</doc-anchor-trigger>
        <span>23.7 Scaling and Performance</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="2371-horizontal-scaling">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2371-horizontal-scaling">#</doc-anchor-trigger>
        <span>23.7.1 Horizontal Scaling</span>
    </h3>
</doc-anchor-target>
<p>Scale out to multiple instances for high traffic.</p>
<doc-anchor-target id="auto-scale-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#auto-scale-configuration">#</doc-anchor-trigger>
        <span>Auto-Scale Configuration</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Enable auto-scale
az monitor autoscale create \
    --resource-group chinook-rg \
    --name chinook-autoscale \
    --resource &quot;/subscriptions/{sub}/resourceGroups/chinook-rg/providers/Microsoft.Web/serverFarms/chinook-plan&quot; \
    --min-count 1 \
    --max-count 5 \
    --count 1

# Add scale-out rule (CPU &gt; 70%)
az monitor autoscale rule create \
    --resource-group chinook-rg \
    --autoscale-name chinook-autoscale \
    --condition &quot;CpuPercentage &gt; 70 avg 5m&quot; \
    --scale out 1

# Add scale-in rule (CPU &lt; 30%)
az monitor autoscale rule create \
    --resource-group chinook-rg \
    --autoscale-name chinook-autoscale \
    --condition &quot;CpuPercentage &lt; 30 avg 10m&quot; \
    --scale in 1

# Add memory-based rule
az monitor autoscale rule create \
    --resource-group chinook-rg \
    --autoscale-name chinook-autoscale \
    --condition &quot;MemoryPercentage &gt; 80 avg 5m&quot; \
    --scale out 1</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="session-affinity-for-htmx">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#session-affinity-for-htmx">#</doc-anchor-trigger>
        <span>Session Affinity for htmx</span>
    </h4>
</doc-anchor-target>
<p>htmx applications are typically stateless, making session affinity unnecessary. Disable it for better load distribution:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Disable session affinity (ARR Affinity)
az webapp config set \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --generic-configurations '{&quot;clientAffinityEnabled&quot;: false}'</code></pre>
</doc-codeblock></div>
<p>Enable session affinity only if your application stores session state in memory (not recommended for production).</p>
<doc-anchor-target id="2372-vertical-scaling">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2372-vertical-scaling">#</doc-anchor-trigger>
        <span>23.7.2 Vertical Scaling</span>
    </h3>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Tier</th>
<th>vCPUs</th>
<th>Memory</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>B1</td>
<td>1</td>
<td>1.75 GB</td>
<td>Dev/Test</td>
</tr>
<tr>
<td>P1v3</td>
<td>2</td>
<td>8 GB</td>
<td>Small production</td>
</tr>
<tr>
<td>P2v3</td>
<td>4</td>
<td>16 GB</td>
<td>Medium production</td>
</tr>
<tr>
<td>P3v3</td>
<td>8</td>
<td>32 GB</td>
<td>High traffic</td>
</tr>
</tbody>
</table>
</div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Scale up to P2v3
az appservice plan update \
    --name chinook-plan \
    --resource-group chinook-rg \
    --sku P2V3</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="load-testing-with-k6">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#load-testing-with-k6">#</doc-anchor-trigger>
        <span>Load Testing with k6</span>
    </h4>
</doc-anchor-target>
<p><strong>loadtest.js:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
    stages: [
        { duration: '30s', target: 20 },  // Ramp up
        { duration: '1m', target: 20 },   // Stay at 20 users
        { duration: '30s', target: 50 },  // Ramp to 50
        { duration: '1m', target: 50 },   // Stay at 50
        { duration: '30s', target: 0 },   // Ramp down
    ],
};

const BASE_URL = 'https://chinook-dashboard.azurewebsites.net';

export default function () {
    // Full page load
    let res = http.get(`${BASE_URL}/Artists`);
    check(res, { 'page loaded': (r) =&gt; r.status === 200 });

    sleep(1);

    // htmx search request
    res = http.get(`${BASE_URL}/Artists?handler=List&amp;search=AC`, {
        headers: {
            'HX-Request': 'true',
            'HX-Target': 'artist-list',
        },
    });
    check(res, { 'htmx search ok': (r) =&gt; r.status === 200 });

    sleep(0.5);

    // htmx edit form
    res = http.get(`${BASE_URL}/Artists?handler=Edit&amp;id=1`, {
        headers: {
            'HX-Request': 'true',
            'HX-Target': 'artist-row-1',
        },
    });
    check(res, { 'htmx edit ok': (r) =&gt; r.status === 200 });

    sleep(1);
}</code></pre>
</doc-codeblock></div>
<p>Run with: <code v-pre>k6 run loadtest.js</code></p>
<doc-anchor-target id="2373-output-caching">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2373-output-caching">#</doc-anchor-trigger>
        <span>23.7.3 Output Caching</span>
    </h3>
</doc-anchor-target>
<p>ASP.NET Core 7+ includes built-in output caching.</p>
<p><strong>Output Caching Configuration:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
builder.Services.AddOutputCache(options =&gt;
{
    // Default policy: no caching
    options.AddBasePolicy(builder =&gt; builder.NoCache());

    // Cache static lookups for 1 hour
    options.AddPolicy(&quot;StaticLookup&quot;, builder =&gt; builder
        .Expire(TimeSpan.FromHours(1))
        .SetVaryByHeader(&quot;HX-Request&quot;)
        .Tag(&quot;lookup&quot;));

    // Cache search results for 5 minutes, vary by search term
    options.AddPolicy(&quot;SearchResults&quot;, builder =&gt; builder
        .Expire(TimeSpan.FromMinutes(5))
        .SetVaryByQuery(&quot;search&quot;, &quot;page&quot;)
        .SetVaryByHeader(&quot;HX-Request&quot;)
        .Tag(&quot;search&quot;));

    // No cache for user-specific content
    options.AddPolicy(&quot;NoCache&quot;, builder =&gt; builder.NoCache());
});

// For multi-instance, use Redis
builder.Services.AddStackExchangeRedisOutputCache(options =&gt;
{
    options.Configuration = builder.Configuration.GetConnectionString(&quot;Redis&quot;);
    options.InstanceName = &quot;chinook:&quot;;
});

// In middleware pipeline
app.UseOutputCache();</code></pre>
</doc-codeblock></div>
<p><strong>Applying Cache Policies to Handlers:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In page model
[OutputCache(PolicyName = &quot;StaticLookup&quot;)]
public async Task&lt;IActionResult&gt; OnGetGenreListAsync()
{
    var genres = await _genreService.GetAllAsync();
    return Partial(&quot;_GenreList&quot;, genres);
}

[OutputCache(PolicyName = &quot;SearchResults&quot;)]
public async Task&lt;IActionResult&gt; OnGetListAsync(string? search, int page = 1)
{
    var artists = await _artistService.SearchAsync(search, page);
    return Partial(&quot;_ArtistList&quot;, artists);
}

[OutputCache(PolicyName = &quot;NoCache&quot;)]
public async Task&lt;IActionResult&gt; OnGetEditAsync(int id)
{
    var artist = await _artistService.GetByIdAsync(id);
    return Partial(&quot;_ArtistEditForm&quot;, artist);
}</code></pre>
</doc-codeblock></div>
<p><strong>Redis Cache Configuration:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Create Azure Cache for Redis
az redis create \
    --name chinook-cache \
    --resource-group chinook-rg \
    --location eastus \
    --sku Basic \
    --vm-size c0

# Get connection string
az redis list-keys \
    --name chinook-cache \
    --resource-group chinook-rg</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2374-database-performance">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2374-database-performance">#</doc-anchor-trigger>
        <span>23.7.4 Database Performance</span>
    </h3>
</doc-anchor-target>
<doc-anchor-target id="azure-sql-recommendations">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#azure-sql-recommendations">#</doc-anchor-trigger>
        <span>Azure SQL Recommendations</span>
    </h4>
</doc-anchor-target>
<ul>
<li>Enable <strong>Query Store</strong> for performance analysis</li>
<li>Use <strong>Automatic Tuning</strong> for index recommendations</li>
<li>Configure <strong>Read Scale-Out</strong> for read-heavy workloads</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Enable Query Store
az sql db update \
    --name ChinookDb \
    --resource-group chinook-rg \
    --server chinook-sql \
    --set requestedServiceObjectiveName=&quot;S1&quot;

# Enable automatic tuning
az sql db update \
    --name ChinookDb \
    --resource-group chinook-rg \
    --server chinook-sql \
    --set automaticTuning=&quot;Auto&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="connection-resiliency">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#connection-resiliency">#</doc-anchor-trigger>
        <span>Connection Resiliency</span>
    </h4>
</doc-anchor-target>
<p>Already configured in Program.cs with <code v-pre>EnableRetryOnFailure</code>. For htmx endpoints with many small queries, connection pooling is critical:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In connection string
&quot;Max Pool Size=100;Min Pool Size=10;Connection Timeout=30;&quot;</code></pre>
</doc-codeblock></div>
<hr>
<doc-anchor-target id="238-security-hardening">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#238-security-hardening">#</doc-anchor-trigger>
        <span>23.8 Security Hardening</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="2381-security-headers">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2381-security-headers">#</doc-anchor-trigger>
        <span>23.8.1 Security Headers</span>
    </h3>
</doc-anchor-target>
<p>htmx requires specific CSP configuration to allow inline event handlers and dynamic content loading.</p>
<p><strong>Middleware/SecurityHeadersMiddleware.cs</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">namespace ChinookDashboard.Middleware;

public class SecurityHeadersMiddleware
{
    private readonly RequestDelegate _next;
    private readonly SecurityHeadersOptions _options;

    public SecurityHeadersMiddleware(RequestDelegate next, SecurityHeadersOptions options)
    {
        _next = next;
        _options = options;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // Content Security Policy - htmx compatible
        var csp = BuildContentSecurityPolicy();
        context.Response.Headers[&quot;Content-Security-Policy&quot;] = csp;

        // Prevent MIME type sniffing
        context.Response.Headers[&quot;X-Content-Type-Options&quot;] = &quot;nosniff&quot;;

        // Clickjacking protection
        context.Response.Headers[&quot;X-Frame-Options&quot;] = _options.AllowFraming ? &quot;SAMEORIGIN&quot; : &quot;DENY&quot;;

        // Referrer policy
        context.Response.Headers[&quot;Referrer-Policy&quot;] = &quot;strict-origin-when-cross-origin&quot;;

        // Permissions policy (formerly Feature-Policy)
        context.Response.Headers[&quot;Permissions-Policy&quot;] = 
            &quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()&quot;;

        // Remove server header
        context.Response.Headers.Remove(&quot;Server&quot;);
        context.Response.Headers.Remove(&quot;X-Powered-By&quot;);

        await _next(context);
    }

    private string BuildContentSecurityPolicy()
    {
        var directives = new List&lt;string&gt;
        {
            // Default: only same origin
            &quot;default-src 'self'&quot;,

            // Scripts: self + htmx + hyperscript + unsafe-inline for htmx attributes
            // In production, consider using nonces instead of unsafe-inline
            $&quot;script-src 'self' {(_options.CdnDomain != null ? _options.CdnDomain : &quot;&quot;)} 'unsafe-inline' 'unsafe-eval'&quot;,

            // Styles: self + inline styles for htmx indicators
            $&quot;style-src 'self' {(_options.CdnDomain != null ? _options.CdnDomain : &quot;&quot;)} 'unsafe-inline'&quot;,

            // Images: self + data URIs + CDN
            $&quot;img-src 'self' data: {(_options.CdnDomain != null ? _options.CdnDomain : &quot;&quot;)}&quot;,

            // Fonts: self + CDN
            $&quot;font-src 'self' {(_options.CdnDomain != null ? _options.CdnDomain : &quot;&quot;)}&quot;,

            // Connect: same origin for htmx requests
            &quot;connect-src 'self'&quot;,

            // Forms: same origin
            &quot;form-action 'self'&quot;,

            // Frame ancestors: prevent embedding
            &quot;frame-ancestors 'none'&quot;,

            // Base URI: same origin
            &quot;base-uri 'self'&quot;,

            // Object/embed: none
            &quot;object-src 'none'&quot;
        };

        return string.Join(&quot;; &quot;, directives);
    }
}

public class SecurityHeadersOptions
{
    public bool AllowFraming { get; set; } = false;
    public string? CdnDomain { get; set; }
    public bool UseStrictCsp { get; set; } = false;
}

public static class SecurityHeadersMiddlewareExtensions
{
    public static IServiceCollection AddSecurityHeaders(
        this IServiceCollection services,
        Action&lt;SecurityHeadersOptions&gt;? configure = null)
    {
        var options = new SecurityHeadersOptions();
        configure?.Invoke(options);
        services.AddSingleton(options);
        return services;
    }

    public static IApplicationBuilder UseSecurityHeaders(this IApplicationBuilder app)
    {
        var options = app.ApplicationServices.GetService&lt;SecurityHeadersOptions&gt;() 
            ?? new SecurityHeadersOptions();
        return app.UseMiddleware&lt;SecurityHeadersMiddleware&gt;(options);
    }
}</code></pre>
</doc-codeblock></div>
<p><strong>Configuration in Program.cs:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// Services
builder.Services.AddSecurityHeaders(options =&gt;
{
    options.CdnDomain = &quot;https://chinook-assets.azureedge.net&quot;;
    options.AllowFraming = false;
});

// Middleware (early in pipeline)
if (!app.Environment.IsDevelopment())
{
    app.UseSecurityHeaders();
    app.UseHsts();
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2382-anti-forgery-in-production">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2382-anti-forgery-in-production">#</doc-anchor-trigger>
        <span>23.8.2 Anti-Forgery in Production</span>
    </h3>
</doc-anchor-target>
<p>In multi-instance deployments, data protection keys must be shared across instances.</p>
<p><strong>Data Protection Configuration:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
using Azure.Identity;
using Azure.Storage.Blobs;
using Microsoft.AspNetCore.DataProtection;

// Configure data protection for production
if (builder.Environment.IsProduction())
{
    var blobServiceClient = new BlobServiceClient(
        new Uri(&quot;https://chinookstorage.blob.core.windows.net&quot;),
        new DefaultAzureCredential());

    var containerClient = blobServiceClient.GetBlobContainerClient(&quot;data-protection-keys&quot;);

    builder.Services.AddDataProtection()
        .SetApplicationName(&quot;ChinookDashboard&quot;)
        .PersistKeysToAzureBlobStorage(containerClient, &quot;keys.xml&quot;)
        .ProtectKeysWithAzureKeyVault(
            new Uri(&quot;https://chinook-vault.vault.azure.net/keys/DataProtectionKey&quot;),
            new DefaultAzureCredential());
}
else
{
    builder.Services.AddDataProtection()
        .SetApplicationName(&quot;ChinookDashboard&quot;);
}</code></pre>
</doc-codeblock></div>
<p><strong>Azure Resource Setup:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Create storage account for data protection keys
az storage account create \
    --name chinookstorage \
    --resource-group chinook-rg \
    --location eastus \
    --sku Standard_LRS

# Create container
az storage container create \
    --name data-protection-keys \
    --account-name chinookstorage \
    --auth-mode login

# Create Key Vault key for encryption
az keyvault key create \
    --vault-name chinook-vault \
    --name DataProtectionKey \
    --protection software

# Grant Web App access to storage
WEBAPP_IDENTITY=$(az webapp identity show --name chinook-dashboard --resource-group chinook-rg --query principalId -o tsv)

az role assignment create \
    --assignee $WEBAPP_IDENTITY \
    --role &quot;Storage Blob Data Contributor&quot; \
    --scope &quot;/subscriptions/{sub}/resourceGroups/chinook-rg/providers/Microsoft.Storage/storageAccounts/chinookstorage&quot;

# Grant access to Key Vault key
az keyvault set-policy \
    --name chinook-vault \
    --object-id $WEBAPP_IDENTITY \
    --key-permissions get unwrapKey wrapKey</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2383-rate-limiting">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2383-rate-limiting">#</doc-anchor-trigger>
        <span>23.8.3 Rate Limiting</span>
    </h3>
</doc-anchor-target>
<p>Protect htmx endpoints from abuse with ASP.NET Core rate limiting.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In Program.cs
using System.Threading.RateLimiting;

builder.Services.AddRateLimiter(options =&gt;
{
    // Global rate limit
    options.GlobalLimiter = PartitionedRateLimiter.Create&lt;HttpContext, string&gt;(context =&gt;
    {
        return RateLimitPartition.GetFixedWindowLimiter(
            partitionKey: context.Connection.RemoteIpAddress?.ToString() ?? &quot;unknown&quot;,
            factory: _ =&gt; new FixedWindowRateLimiterOptions
            {
                PermitLimit = 100,
                Window = TimeSpan.FromMinutes(1),
                QueueProcessingOrder = QueueProcessingOrder.OldestFirst,
                QueueLimit = 10
            });
    });

    // Stricter limit for search (htmx debounced, but protect against abuse)
    options.AddPolicy(&quot;search&quot;, context =&gt;
    {
        return RateLimitPartition.GetSlidingWindowLimiter(
            partitionKey: context.Connection.RemoteIpAddress?.ToString() ?? &quot;unknown&quot;,
            factory: _ =&gt; new SlidingWindowRateLimiterOptions
            {
                PermitLimit = 30,
                Window = TimeSpan.FromMinutes(1),
                SegmentsPerWindow = 6,
                QueueProcessingOrder = QueueProcessingOrder.OldestFirst,
                QueueLimit = 5
            });
    });

    // Very strict for write operations
    options.AddPolicy(&quot;write&quot;, context =&gt;
    {
        return RateLimitPartition.GetFixedWindowLimiter(
            partitionKey: context.Connection.RemoteIpAddress?.ToString() ?? &quot;unknown&quot;,
            factory: _ =&gt; new FixedWindowRateLimiterOptions
            {
                PermitLimit = 20,
                Window = TimeSpan.FromMinutes(1),
                QueueProcessingOrder = QueueProcessingOrder.OldestFirst,
                QueueLimit = 2
            });
    });

    // Custom response for htmx requests
    options.OnRejected = async (context, cancellationToken) =&gt;
    {
        context.HttpContext.Response.StatusCode = StatusCodes.Status429TooManyRequests;

        if (context.HttpContext.Request.Headers.ContainsKey(&quot;HX-Request&quot;))
        {
            context.HttpContext.Response.ContentType = &quot;text/html&quot;;
            await context.HttpContext.Response.WriteAsync(
                &quot;&lt;div class=\&quot;text-red-600\&quot;&gt;Too many requests. Please slow down.&lt;/div&gt;&quot;,
                cancellationToken);
        }
        else
        {
            await context.HttpContext.Response.WriteAsync(
                &quot;Rate limit exceeded. Please try again later.&quot;,
                cancellationToken);
        }
    };
});

// In middleware pipeline (after routing)
app.UseRateLimiter();</code></pre>
</doc-codeblock></div>
<p><strong>Applying Rate Limits to Handlers:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-csharp"><code v-pre class="language-csharp">// In page model
[EnableRateLimiting(&quot;search&quot;)]
public async Task&lt;IActionResult&gt; OnGetListAsync(string? search)
{
    // ...
}

[EnableRateLimiting(&quot;write&quot;)]
public async Task&lt;IActionResult&gt; OnPostCreateAsync()
{
    // ...
}</code></pre>
</doc-codeblock></div>
<hr>
<doc-anchor-target id="239-cost-optimization">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#239-cost-optimization">#</doc-anchor-trigger>
        <span>23.9 Cost Optimization</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="2391-right-sizing-resources">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2391-right-sizing-resources">#</doc-anchor-trigger>
        <span>23.9.1 Right-Sizing Resources</span>
    </h3>
</doc-anchor-target>
<p>Monitor actual usage before choosing tiers:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># View App Service metrics
az monitor metrics list \
    --resource &quot;/subscriptions/{sub}/resourceGroups/chinook-rg/providers/Microsoft.Web/sites/chinook-dashboard&quot; \
    --metric &quot;CpuPercentage,MemoryPercentage&quot; \
    --interval PT1H \
    --start-time 2024-01-01T00:00:00Z

# Get Azure Advisor recommendations
az advisor recommendation list \
    --resource-group chinook-rg \
    --category cost</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="2392-cost-saving-strategies">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2392-cost-saving-strategies">#</doc-anchor-trigger>
        <span>23.9.2 Cost-Saving Strategies</span>
    </h3>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Strategy</th>
<th>Savings</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auto-shutdown dev/test</td>
<td>60-70%</td>
<td>Schedule via Azure Automation</td>
</tr>
<tr>
<td>Reserved Instances (1yr)</td>
<td>30-40%</td>
<td>Commit to production workloads</td>
</tr>
<tr>
<td>Reserved Instances (3yr)</td>
<td>50-60%</td>
<td>Long-term stable workloads</td>
</tr>
<tr>
<td>Azure Hybrid Benefit</td>
<td>40%</td>
<td>Use existing Windows licenses</td>
</tr>
<tr>
<td>Blob Storage for static</td>
<td>Variable</td>
<td>Offload from App Service</td>
</tr>
<tr>
<td>Right-size SQL tier</td>
<td>20-50%</td>
<td>Monitor DTU usage</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Auto-Shutdown for Dev/Test:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Create automation account and schedule
# Or use built-in App Service feature for dev/test slots

# Stop staging slot during off-hours
az webapp stop \
    --name chinook-dashboard \
    --resource-group chinook-rg \
    --slot staging</code></pre>
</doc-codeblock></div>
<p><strong>Estimated Monthly Costs (East US):</strong></p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Component</th>
<th>Dev/Test</th>
<th>Production</th>
</tr>
</thead>
<tbody>
<tr>
<td>App Service (B1/P1v3)</td>
<td>$13</td>
<td>$145</td>
</tr>
<tr>
<td>SQL Database (S0/S1)</td>
<td>$15</td>
<td>$30</td>
</tr>
<tr>
<td>Key Vault</td>
<td>$0.03/operation</td>
<td>$0.03/operation</td>
</tr>
<tr>
<td>Application Insights</td>
<td>Free tier</td>
<td>$2.30/GB</td>
</tr>
<tr>
<td>CDN</td>
<td>$0.08/GB</td>
<td>$0.08/GB</td>
</tr>
<tr>
<td><strong>Total (est.)</strong></td>
<td><strong>~$30</strong></td>
<td><strong>~$200</strong></td>
</tr>
</tbody>
</table>
</div>
<hr>
<doc-anchor-target id="2310-summary">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2310-summary">#</doc-anchor-trigger>
        <span>23.10 Summary</span>
    </h2>
</doc-anchor-target>
<p>Deploying htmx applications to Azure requires attention to configuration, security, monitoring, and performance. This chapter covered the complete deployment lifecycle.</p>
<doc-anchor-target id="deployment-checklist">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#deployment-checklist">#</doc-anchor-trigger>
        <span>Deployment Checklist</span>
    </h3>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Category</th>
<th>Item</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Configuration</strong></td>
<td>appsettings.Production.json</td>
<td>Environment-specific settings</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>Connection strings in Key Vault</td>
<td>Never in source control</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>Logging levels set</td>
<td>Warning for framework, Info for app</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>Data protection keys configured</td>
<td>Azure Blob + Key Vault</td>
</tr>
<tr>
<td><strong>Assets</strong></td>
<td>Static files minified</td>
<td>htmx.min.js, site.min.css</td>
</tr>
<tr>
<td><strong>Assets</strong></td>
<td>Cache headers configured</td>
<td>1 year for fingerprinted assets</td>
</tr>
<tr>
<td><strong>Assets</strong></td>
<td>CDN configured (optional)</td>
<td>For global distribution</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Response compression enabled</td>
<td>Brotli + Gzip</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Output caching configured</td>
<td>For cacheable htmx responses</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Auto-scale rules set</td>
<td>CPU and memory thresholds</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>HTTPS enforced</td>
<td>HSTS enabled</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>Security headers set</td>
<td>CSP, X-Frame-Options</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>Rate limiting configured</td>
<td>Protect htmx endpoints</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Application Insights configured</td>
<td>htmx telemetry middleware</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Health checks implemented</td>
<td>/health endpoint</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Alerts configured</td>
<td>Error rate, response time</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>Build pipeline working</td>
<td>GitHub Actions</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>Test pipeline working</td>
<td>Unit + Integration + Browser</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>Deployment pipeline working</td>
<td>Staging → Production</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>Rollback procedure documented</td>
<td>Slot swap back</td>
</tr>
</tbody>
</table>
</div>
<doc-anchor-target id="key-azure-services">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#key-azure-services">#</doc-anchor-trigger>
        <span>Key Azure Services</span>
    </h3>
</doc-anchor-target>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th>Service</th>
<th>Purpose</th>
<th>Recommended Tier</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure App Service</td>
<td>Application hosting</td>
<td>P1v3 for production</td>
</tr>
<tr>
<td>Azure SQL Database</td>
<td>Relational data</td>
<td>S1 for production</td>
</tr>
<tr>
<td>Azure Key Vault</td>
<td>Secrets management</td>
<td>Standard</td>
</tr>
<tr>
<td>Azure CDN</td>
<td>Static asset delivery</td>
<td>Standard Microsoft</td>
</tr>
<tr>
<td>Application Insights</td>
<td>Monitoring</td>
<td>Pay-as-you-go</td>
</tr>
<tr>
<td>Azure Monitor</td>
<td>Alerts</td>
<td>Included</td>
</tr>
<tr>
<td>Azure Blob Storage</td>
<td>Data protection keys</td>
<td>Standard LRS</td>
</tr>
<tr>
<td>Azure Cache for Redis</td>
<td>Distributed caching</td>
<td>Basic C0</td>
</tr>
</tbody>
</table>
</div>
<doc-anchor-target id="cicd-pipeline-flow">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cicd-pipeline-flow">#</doc-anchor-trigger>
        <span>CI/CD Pipeline Flow</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────────┐              │
│  │  Push   │ →  │  Build  │ →  │  Test   │ →  │ Staging  │              │
│  │ to main │    │         │    │         │    │ Deploy   │              │
│  └─────────┘    └─────────┘    └─────────┘    └────┬─────┘              │
│                                                     │                    │
│                                                     ▼                    │
│                                              ┌──────────┐                │
│                                              │  Health  │                │
│                                              │  Check   │                │
│                                              └────┬─────┘                │
│                                                   │                      │
│                                                   ▼                      │
│                                              ┌──────────┐   ┌─────────┐  │
│                                              │ Approval │ → │  Swap   │  │
│                                              │ (manual) │   │  Slots  │  │
│                                              └──────────┘   └─────────┘  │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="htmx-specific-deployment-tips">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#htmx-specific-deployment-tips">#</doc-anchor-trigger>
        <span>htmx-Specific Deployment Tips</span>
    </h3>
</doc-anchor-target>
<ol>
<li><p><strong>Compression</strong>: Enable Brotli compression for htmx partial responses. Even small fragments benefit from compression.</p>
</li>
<li><p><strong>Caching</strong>: Use output caching selectively. Cache static lookups and navigation, but never user-specific content or form submissions.</p>
</li>
<li><p><strong>Error Handling</strong>: Return HTML partials for htmx errors using HX-Retarget. Full error pages break the htmx UX.</p>
</li>
<li><p><strong>Health Checks</strong>: Include an htmx-compatible health endpoint that returns HTML for dashboard displays.</p>
</li>
<li><p><strong>Telemetry</strong>: Track htmx requests separately in Application Insights. Add HX-Target and handler as custom properties.</p>
</li>
<li><p><strong>Security Headers</strong>: Configure CSP to allow htmx&#x27;s inline event handlers (<code v-pre>unsafe-inline</code> or nonces).</p>
</li>
<li><p><strong>Rate Limiting</strong>: Apply stricter limits to search endpoints even with client-side debouncing.</p>
</li>
</ol>
<doc-anchor-target id="companion-code-files">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#companion-code-files">#</doc-anchor-trigger>
        <span>Companion Code Files</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">chap23/
├── ChinookDashboard/
│   ├── appsettings.json
│   ├── appsettings.Production.json
│   ├── Program.cs
│   ├── Middleware/
│   │   ├── HtmxTelemetryMiddleware.cs
│   │   ├── HtmxResponseCachingMiddleware.cs
│   │   ├── ProductionExceptionMiddleware.cs
│   │   └── SecurityHeadersMiddleware.cs
│   ├── Health/
│   │   ├── DatabaseHealthCheck.cs
│   │   └── HealthCheckExtensions.cs
│   └── Pages/
│       └── Shared/
│           ├── _Error404.cshtml
│           └── _Error500.cshtml
├── .github/
│   └── workflows/
│       ├── build-test.yml
│       ├── deploy.yml
│       └── azure-deploy.yml
├── infrastructure/
│   ├── azure-setup.sh
│   ├── setup-cdn.sh
│   ├── setup-domain.sh
│   └── create-service-principal.sh
├── tests/
│   └── loadtest.js
├── bundleconfig.json
├── libman.json
└── README.md</code></pre>
</doc-codeblock></div>
<p>With these configurations in place, your htmx application is ready for production traffic on Azure. The automated pipeline ensures consistent deployments, while monitoring and alerting provide visibility into application health. As traffic grows, the scaling configurations handle increased load automatically.</p>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                                <div class="flex flex-wrap items-center justify-between mt-14">
                                    <a id="retype-edit-this-page" class="my-2.5 inline-flex items-center text-sm whitespace-nowrap text-body-link font-body-link-weight hover:text-body-link-hover hover:underline" href="https://github.com/cwoodruff/book-aspnet-htmx/blob/main/Chapter23/chapter23.md" target="_blank" rel="noopener">
                                        <svg class="mr-1.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M20 12c-.55 0-1 .45-1 1v7c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h7c.55 0 1-.45 1-1s-.45-1-1-1H4C2.35 3 1 4.35 1 6v14c0 1.65 1.35 3 3 3h14c1.65 0 3-1.35 3-3v-7c0-.55-.45-1-1-1z" /><path d="M22.21 1.79c-1.18-1.18-3.24-1.18-4.41 0l-9.5 9.5c-.13.13-.22.29-.26.46l-1 4c-.08.34.01.7.26.95.18.2.44.3.7.3.08 0 .16-.01.24-.03l4-1c.18-.04.34-.13.46-.26l9.5-9.5c1.22-1.22 1.22-3.2.01-4.42zm-1.42 3l-9.3 9.3-2.11.53.53-2.11 9.3-9.3c.42-.42 1.16-.42 1.59 0 .43.43.43 1.15-.01 1.58z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        <span>Edit this page</span>
                                    </a>
                                </div>
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../chapter22/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">Chap 22 - Testing htmx Applications</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../appendix/htmx-command-reference/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">Appendix A - htmx Command Reference</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                        <li>
                                            <a class="inline-flex items-center mr-4 py-2 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-footer-link hover:text-footer-link-hover md:mb-0" href="../copyright/">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                    <g fill="currentColor">
                                                        <path d="M10.97 8.265a1.45 1.45 0 0 0-.487.57.75.75 0 0 1-1.341-.67c.2-.402.513-.826.997-1.148C10.627 6.69 11.244 6.5 12 6.5c.658 0 1.369.195 1.934.619a2.45 2.45 0 0 1 1.004 2.006c0 1.033-.513 1.72-1.027 2.215-.19.183-.399.358-.579.508l-.147.123a4.329 4.329 0 0 0-.435.409v1.37a.75.75 0 1 1-1.5 0v-1.473c0-.237.067-.504.247-.736.22-.28.486-.517.718-.714l.183-.153.001-.001c.172-.143.324-.27.47-.412.368-.355.569-.676.569-1.136a.953.953 0 0 0-.404-.806C12.766 8.118 12.384 8 12 8c-.494 0-.814.121-1.03.265ZM13 17a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/><path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/>
                                                    </g>
                                                </svg>
                                                <span>Copyright</span>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="inline-flex items-center mr-4 py-2 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-footer-link hover:text-footer-link-hover md:mb-0" href="../license/">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                    <g fill="currentColor">
                                                        <path d="M16.53 9.78a.75.75 0 0 0-1.06-1.06L11 13.19l-1.97-1.97a.75.75 0 0 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l5-5Z"/><path d="m12.54.637 8.25 2.675A1.75 1.75 0 0 1 22 4.976V10c0 6.19-3.771 10.704-9.401 12.83a1.704 1.704 0 0 1-1.198 0C5.77 20.705 2 16.19 2 10V4.976c0-.758.489-1.43 1.21-1.664L11.46.637a1.748 1.748 0 0 1 1.08 0Zm-.617 1.426-8.25 2.676a.249.249 0 0 0-.173.237V10c0 5.46 3.28 9.483 8.43 11.426a.199.199 0 0 0 .14 0C17.22 19.483 20.5 15.461 20.5 10V4.976a.25.25 0 0 0-.173-.237l-8.25-2.676a.253.253 0 0 0-.154 0Z"/>
                                                    </g>
                                                </svg>
                                                <span>License</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© Copyright 2026. All rights reserved Chris Woodruff.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Chap 23 - Deploying htmx Applications on Azure", level: 1, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
